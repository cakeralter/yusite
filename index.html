<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>积存金交易记录</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f7;
            color: #1d1d1f;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 28px;
            color: #1d1d1f;
            margin-bottom: 10px;
        }

        /* 核心盈亏面板样式 */
        .profit-overview {
            margin-bottom: 30px;
        }

        .profit-main-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 16px;
            padding: 30px;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .profit-main-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            pointer-events: none;
        }

        .profit-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .profit-header h2 {
            font-size: 18px;
            font-weight: 600;
            margin: 0;
        }

        .profit-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            backdrop-filter: blur(10px);
        }

        .profit-badge.profit { background: rgba(255, 59, 48, 0.8); }
        .profit-badge.loss { background: rgba(52, 199, 89, 0.8); }
        .profit-badge.neutral { background: rgba(255, 255, 255, 0.2); }

        .profit-amount {
            display: flex;
            align-items: baseline;
            margin-bottom: 10px;
        }

        .profit-amount .amount {
            font-size: 36px;
            font-weight: 700;
            margin-right: 8px;
        }

        .profit-amount .unit {
            font-size: 18px;
            opacity: 0.8;
        }

        .profit-rate {
            margin-bottom: 20px;
        }

        .profit-rate .rate {
            font-size: 20px;
            font-weight: 600;
            margin-right: 8px;
        }

        .profit-rate .desc {
            font-size: 14px;
            opacity: 0.8;
        }

        .profit-detail {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .detail-item .label {
            font-size: 12px;
            opacity: 0.7;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .detail-item .value {
            font-size: 16px;
            font-weight: 600;
        }

        .funds-progress {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .progress-label {
            font-size: 12px;
            opacity: 0.7;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .progress-text {
            font-size: 14px;
            font-weight: 600;
        }

        .progress-bar {
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #34c759, #30d158);
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .progress-detail {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            opacity: 0.8;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .sub-value {
            font-size: 12px;
            color: #86868b;
            margin-top: 5px;
        }

        .summary-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .summary-card h3 {
            font-size: 14px;
            color: #86868b;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .summary-card .value {
            font-size: 24px;
            font-weight: 600;
            color: #1d1d1f;
        }

        .summary-card .unit {
            font-size: 14px;
            color: #86868b;
            margin-left: 4px;
        }

        .profit-positive { color: #ff3b30; }
        .profit-negative { color: #34c759; }

        .section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .section h2 {
            font-size: 20px;
            margin-bottom: 20px;
            color: #1d1d1f;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            align-items: end;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-size: 14px;
            color: #86868b;
            margin-bottom: 5px;
        }

        .form-group input, .form-group select {
            padding: 12px;
            border: 1px solid #d2d2d7;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #007aff;
        }

        .btn {
            background: #007aff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.2s;
            touch-action: manipulation; /* 防止双击缩放 */
            -webkit-tap-highlight-color: transparent; /* 去除点击高亮 */
        }

        .btn:hover {
            background: #0056b3;
        }

        .btn-danger {
            background: #ff3b30;
        }

        .btn-danger:hover {
            background: #d70015;
        }

        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch; /* iOS平滑滚动 */
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #d2d2d7;
        }

        th {
            background: #f5f5f7;
            font-weight: 600;
            color: #1d1d1f;
        }

        .type-buy {
            color: #ff3b30;
            font-weight: 600;
        }

        .type-sell {
            color: #34c759;
            font-weight: 600;
        }

        .delete-btn {
            background: none;
            border: none;
            color: #ff3b30;
            cursor: pointer;
            font-size: 16px;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background 0.2s;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            min-height: 44px; /* iOS推荐的最小触摸区域 */
            min-width: 44px;
        }

        .delete-btn:hover {
            background: rgba(255, 59, 48, 0.1);
        }

        /* 移动端适配 */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .header {
                margin-bottom: 20px;
                text-align: left;
                display: flex;
                justify-content: space-between;
                align-items: center;
                flex-wrap: wrap;
                gap: 10px;
            }

            .header h1 {
                font-size: 24px;
                margin-bottom: 0;
            }

            .btn-config {
                margin: 0;
                padding: 8px 16px;
                font-size: 14px;
            }

            .profit-main-card {
                padding: 20px;
                margin: 0 -5px;
            }

            .profit-amount .amount {
                font-size: 28px;
            }

            .profit-detail {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .funds-progress {
                margin-top: 15px;
                padding-top: 15px;
            }

            .progress-detail {
                flex-direction: column;
                gap: 4px;
                align-items: flex-start;
            }

            .summary-grid {
                grid-template-columns: 1fr 1fr;
                gap: 15px;
            }

            .summary-card {
                padding: 15px;
            }

            .summary-card h3 {
                font-size: 12px;
            }

            .summary-card .value {
                font-size: 18px;
            }

            .sub-value {
                font-size: 10px;
            }

            .form-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .section {
                padding: 20px;
                margin-bottom: 20px;
            }

            .section h2 {
                font-size: 18px;
                margin-bottom: 15px;
            }

                         /* 表格移动端优化 */
            .table-container {
                overflow-x: auto;
                margin: 0 -20px;
                padding: 0 20px;
                position: relative;
            }

            .table-container::after {
                content: '← 滑动查看更多 →';
                position: absolute;
                bottom: -25px;
                left: 50%;
                transform: translateX(-50%);
                font-size: 12px;
                color: #86868b;
                white-space: nowrap;
            }

            table {
                min-width: 600px;
                font-size: 14px;
            }

            th, td {
                padding: 8px 6px;
                white-space: nowrap;
            }

            th {
                font-size: 12px;
            }

            /* 删除按钮移动端优化 */
            .delete-btn {
                font-size: 14px;
                padding: 2px 6px;
            }

            /* 弹窗移动端优化 */
            .modal-content {
                margin: 10% auto;
                width: 95%;
                max-width: none;
                padding: 20px;
                max-height: 80vh;
                overflow-y: auto;
            }

            .modal-header h3 {
                font-size: 18px;
            }

            .config-section {
                margin-bottom: 20px;
            }

            .config-section h4 {
                font-size: 14px;
            }

            .form-group input, .form-group select {
                padding: 10px;
                font-size: 16px; /* 防止iOS缩放 */
            }

            .btn {
                padding: 10px 20px;
                font-size: 14px;
                width: 100%;
            }

            .config-info {
                padding: 12px;
                font-size: 12px;
            }
        }

        /* 超小屏幕适配 */
        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }

            .header {
                flex-direction: column;
                align-items: stretch;
                text-align: center;
                gap: 15px;
            }

            .btn-config {
                width: 100%;
            }

            .summary-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .profit-main-card {
                margin: 0;
                padding: 15px;
            }

            .profit-amount .amount {
                font-size: 24px;
            }

            .profit-header h2 {
                font-size: 16px;
            }

            .detail-item .value {
                font-size: 14px;
            }

            .section {
                padding: 15px;
                margin-bottom: 15px;
            }

            .table-container {
                margin: 0 -15px;
                padding: 0 15px;
            }

            table {
                min-width: 500px;
                font-size: 12px;
            }

            th, td {
                padding: 6px 4px;
            }

            .modal-content {
                margin: 5% auto;
                padding: 15px;
                width: 98%;
            }
        }

        /* 弹窗样式 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #d2d2d7;
        }

        .modal-header h3 {
            font-size: 20px;
            color: #1d1d1f;
            margin: 0;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            color: #86868b;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.2s;
        }

        .close-btn:hover {
            background: rgba(134, 134, 139, 0.1);
        }

        .config-section {
            margin-bottom: 25px;
        }

        .config-section:last-child {
            margin-bottom: 0;
        }

        .config-section h4 {
            font-size: 16px;
            color: #1d1d1f;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid #f5f5f7;
        }

        .config-info {
            margin-top: 15px;
            padding: 15px;
            background: #f5f5f7;
            border-radius: 8px;
            font-size: 14px;
            color: #86868b;
        }

        .btn-config {
            background: #34c759;
            margin-left: auto;
            margin-right: 20px;
        }

        .btn-config:hover {
            background: #28a745;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>积存金交易记录</h1>
            <button class="btn btn-config" onclick="openConfigModal()">系统配置</button>
        </div>

        <!-- 核心盈亏面板 -->
        <div class="profit-overview">
            <div class="profit-main-card">
                <div class="profit-header">
                    <h2>总盈亏状况</h2>
                    <div class="profit-badge" id="profitBadge">持平</div>
                </div>
                <div class="profit-amount" id="totalProfitLoss">
                    <span class="amount">0</span>
                    <span class="unit">元</span>
                </div>
                <div class="profit-rate" id="totalProfitRate">
                    <span class="rate">0%</span>
                    <span class="desc">总收益率</span>
                </div>
                <div class="profit-detail">
                    <div class="detail-item">
                        <span class="label">当前价值</span>
                        <span class="value" id="currentTotalValue">0元</span>
                    </div>
                    <div class="detail-item">
                        <span class="label">投入本金</span>
                        <span class="value" id="principalAmount">0元</span>
                    </div>
                </div>
                
                <div class="funds-progress">
                    <div class="progress-header">
                        <span class="progress-label">资金使用情况</span>
                        <span class="progress-text" id="fundsProgressText">0 / 0</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="fundsProgressFill"></div>
                    </div>
                    <div class="progress-detail">
                        <span>剩余: <span id="remainingFundsAmount">0元</span></span>
                        <span>使用率: <span id="fundsUsageRate">0%</span></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 详细统计面板 -->
        <div class="summary-grid">
            <div class="summary-card">
                <h3>总持仓</h3>
                <div class="value" id="totalPosition">0<span class="unit">克</span></div>
                <div class="sub-value">均价: <span id="avgPriceDisplay">0</span>元/克</div>
            </div>
            <div class="summary-card">
                <h3>保本线</h3>
                <div class="value" id="breakEvenPrice">0<span class="unit">元/克</span></div>
                <div class="sub-value" id="breakEvenStatus">需上涨: 0元/克</div>
            </div>
            <div class="summary-card">
                <h3>累计交易</h3>
                <div class="value" id="totalTrades">0<span class="unit">笔</span></div>
                <div class="sub-value">买入: <span id="buyTrades">0</span> | 卖出: <span id="sellTrades">0</span></div>
            </div>
            <div class="summary-card">
                <h3>已实现盈亏</h3>
                <div class="value" id="realizedProfitLoss">0<span class="unit">元</span></div>
                <div class="sub-value">手续费: <span id="totalFees">0</span>元</div>
            </div>
            <div class="summary-card">
                <h3>距离目标</h3>
                <div class="value" id="targetProgress">-<span class="unit">%</span></div>
                <div class="sub-value">目标价: <span id="targetPrice">-</span>元/克</div>
            </div>
        </div>

        <div class="section">
            <h2>分银行持仓详情</h2>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>银行</th>
                            <th>持仓克数</th>
                            <th>成本均价</th>
                            <th>保本均价</th>
                            <th>当前价值</th>
                            <th>盈亏</th>
                        </tr>
                    </thead>
                    <tbody id="bankSummaryTable">
                    </tbody>
                </table>
            </div>
        </div>



        <div class="section">
            <h2>添加交易记录</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label for="tradeType">交易类型</label>
                    <select id="tradeType">
                        <option value="buy">买入</option>
                        <option value="sell">卖出</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="bank">银行</label>
                    <select id="bank">
                        <option value="民生银行">民生银行</option>
                        <option value="民生银行(JD)">民生银行(JD)</option>
                        <option value="浙商银行(JD)">浙商银行(JD)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="weight">克数</label>
                    <input type="number" id="weight" step="0.01" placeholder="10.00">
                </div>
                <div class="form-group">
                    <label for="price">单价 (元/克)</label>
                    <input type="number" id="price" step="0.01" placeholder="520.00">
                </div>
                <div class="form-group">
                    <label for="tradeDate">交易日期</label>
                    <input type="date" id="tradeDate">
                </div>
                <div class="form-group">
                    <button class="btn" onclick="addTransaction()">添加记录</button>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>交易记录</h2>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>日期</th>
                            <th>类型</th>
                            <th>银行</th>
                            <th>克数</th>
                            <th>单价</th>
                            <th>金额</th>
                            <th>手续费</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="transactionTable">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 配置弹窗 -->
    <div id="configModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>系统配置</h3>
                <button class="close-btn" onclick="closeConfigModal()">&times;</button>
            </div>
            
            <div class="config-section">
                <h4>当前金价设置</h4>
                <div class="form-group">
                    <label for="modalCurrentGoldPrice">当前金价 (元/克)</label>
                    <input type="number" id="modalCurrentGoldPrice" step="0.01" value="520" placeholder="520.00">
                </div>
                <button class="btn" onclick="updateCurrentPrice()">更新金价</button>
            </div>

            <div class="config-section">
                <h4>总资金配置</h4>
                <div class="form-group">
                    <label for="modalTotalFunds">总资金 (元)</label>
                    <input type="number" id="modalTotalFunds" step="0.01" placeholder="包含线下等其他投资资金">
                </div>
                <button class="btn" onclick="updateTotalFunds()">更新总资金</button>
                
                <div class="config-info">
                    <div style="font-weight: 600; margin-bottom: 8px;">资金配置说明：</div>
                    <div>
                        设置总资金：<span id="displayTotalFunds">0</span>元 | 
                        已记录投入：<span id="displayRecordedFunds">0</span>元 | 
                        未记录投入：<span id="displayUnrecordedFunds">0</span>元
                    </div>
                    <div style="margin-top: 8px; font-size: 13px;">
                        * 总资金包含所有黄金投资（线上记录 + 线下投资）<br>
                        * 用于更准确计算整体投资收益情况
                    </div>
                </div>
            </div>

            <div class="config-section">
                <h4>投资目标设置</h4>
                <div class="form-group">
                    <label for="modalTargetPrice">目标价格 (元/克)</label>
                    <input type="number" id="modalTargetPrice" step="0.01" placeholder="设置您的盈利目标价格">
                </div>
                <button class="btn" onclick="updateTargetPrice()">设置目标</button>
                
                <div class="config-info">
                    <div style="font-weight: 600; margin-bottom: 8px;">目标设置说明：</div>
                    <div style="font-size: 13px;">
                        * 设置目标价格后可查看距离目标的进度<br>
                        * 系统将根据目标计算建议操作策略
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let transactions = JSON.parse(localStorage.getItem('goldTransactions')) || [];
        let currentGoldPrice = parseFloat(localStorage.getItem('currentGoldPrice')) || 520;
        let totalFunds = parseFloat(localStorage.getItem('totalFunds')) || 0;
        let targetPrice = parseFloat(localStorage.getItem('targetPrice')) || 0;

        // 初始化
        document.getElementById('modalCurrentGoldPrice').value = currentGoldPrice;
        document.getElementById('modalTotalFunds').value = totalFunds;
        document.getElementById('modalTargetPrice').value = targetPrice;
        document.getElementById('tradeDate').value = new Date().toISOString().split('T')[0];
        
        renderTransactions();
        updateSummary();

        function addTransaction() {
            const type = document.getElementById('tradeType').value;
            const bank = document.getElementById('bank').value;
            const weight = parseFloat(document.getElementById('weight').value);
            const price = parseFloat(document.getElementById('price').value);
            const date = document.getElementById('tradeDate').value;

            if (!weight || !price || !date) {
                alert('请填写完整信息');
                return;
            }

            const amount = weight * price;
            const fee = calculateFee(type, bank, weight, amount);

            transactions.push({
                id: Date.now(),
                type,
                bank,
                weight: type === 'sell' ? -weight : weight,
                price,
                amount: type === 'sell' ? -amount : amount,
                fee,
                date
            });

            saveData();
            renderTransactions();
            updateSummary();
            clearForm();
        }

        function calculateFee(type, bank, weight, amount) {
            if (type === 'buy') return 0;
            
            if (bank === '民生银行') {
                return Math.abs(weight) * 3; // 3元每克
            } else if (bank.includes('(JD)')) {
                return amount * 0.004; // 千分之四
            }
            return 0;
        }

        function deleteTransaction(id) {
            transactions = transactions.filter(t => t.id !== id);
            saveData();
            renderTransactions();
            updateSummary();
        }

        function renderTransactions() {
            const tbody = document.getElementById('transactionTable');
            tbody.innerHTML = '';

            transactions.slice().reverse().forEach(transaction => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${transaction.date}</td>
                    <td class="${transaction.type === 'buy' ? 'type-buy' : 'type-sell'}">
                        ${transaction.type === 'buy' ? '买入' : '卖出'}
                    </td>
                    <td>${transaction.bank}</td>
                    <td>${parseFloat(Math.abs(transaction.weight).toFixed(4))}</td>
                    <td>${parseFloat(transaction.price.toFixed(4))}</td>
                    <td>${parseFloat(Math.abs(transaction.amount).toFixed(4))}</td>
                    <td>${parseFloat(transaction.fee.toFixed(4))}</td>
                    <td><button class="delete-btn" onclick="deleteTransaction(${transaction.id})">删除</button></td>
                `;
            });
        }

        function updateSummary() {
            // 基础数据计算
            const recordedWeight = transactions.reduce((sum, t) => sum + t.weight, 0);
            const totalInvested = transactions.filter(t => t.type === 'buy').reduce((sum, t) => sum + t.amount, 0);
            const totalSold = Math.abs(transactions.filter(t => t.type === 'sell').reduce((sum, t) => sum + t.amount, 0));
            const totalFeesAmount = transactions.reduce((sum, t) => sum + t.fee, 0);
            const buyTransactions = transactions.filter(t => t.type === 'buy').length;
            const sellTransactions = transactions.filter(t => t.type === 'sell').length;
            
            // 修正计算逻辑
            const avgPrice = recordedWeight > 0 ? totalInvested / recordedWeight : 0;
            const actualTotalFunds = totalFunds || totalInvested;
            
            // 总持仓就是记录的实际持仓重量
            const actualTotalWeight = recordedWeight;
            
            // 当前价值 = 实际持仓重量 * 当前金价
            const currentValue = actualTotalWeight * currentGoldPrice;
            
            // 剩余资金 = 总资金 - 已投入资金
            const remainingFunds = actualTotalFunds - totalInvested;
            
            // 总盈亏 = 当前价值 - 已投入资金 + 卖出收入 - 手续费
            const totalProfitLoss = currentValue - totalInvested + totalSold - totalFeesAmount;
            const profitRate = totalInvested > 0 ? (totalProfitLoss / totalInvested) * 100 : 0;
            
            // 计算保本均价
            let breakEvenPrice = 0;
            if (avgPrice > 0) {
                const maxFeeRate = 3;
                breakEvenPrice = avgPrice + maxFeeRate;
            }
            
            // 计算已实现盈亏（仅卖出交易）
            const realizedProfitLoss = totalSold - totalFeesAmount;
            
            // 计算风险等级
            const riskLevel = calculateRiskLevel(actualTotalWeight, actualTotalFunds);
            
            // 计算目标进度
            let targetProgress = 0;
            if (targetPrice > 0 && currentGoldPrice > 0) {
                targetProgress = ((currentGoldPrice - breakEvenPrice) / (targetPrice - breakEvenPrice)) * 100;
            }

            // 更新核心盈亏面板
            updateProfitOverview(totalProfitLoss, profitRate, totalInvested, currentValue, actualTotalFunds, remainingFunds);
            
            // 更新详细统计
            document.getElementById('totalPosition').innerHTML = `${parseFloat(actualTotalWeight.toFixed(4))}<span class="unit">克</span>`;
            document.getElementById('avgPriceDisplay').textContent = parseFloat(avgPrice.toFixed(4));
            
            document.getElementById('breakEvenPrice').innerHTML = `${parseFloat(breakEvenPrice.toFixed(4))}<span class="unit">元/克</span>`;
            const breakEvenDiff = breakEvenPrice - currentGoldPrice;
            document.getElementById('breakEvenStatus').innerHTML = breakEvenDiff > 0 ? 
                `需上涨: ${parseFloat(breakEvenDiff.toFixed(4))}元/克` : 
                `已超过: ${parseFloat(Math.abs(breakEvenDiff).toFixed(4))}元/克`;
            
            document.getElementById('totalTrades').innerHTML = `${buyTransactions + sellTransactions}<span class="unit">笔</span>`;
            document.getElementById('buyTrades').textContent = buyTransactions;
            document.getElementById('sellTrades').textContent = sellTransactions;
            
            const realizedElement = document.getElementById('realizedProfitLoss');
            realizedElement.innerHTML = `${parseFloat(realizedProfitLoss.toFixed(4))}<span class="unit">元</span>`;
            realizedElement.className = `value ${realizedProfitLoss >= 0 ? 'profit-positive' : 'profit-negative'}`;
            document.getElementById('totalFees').textContent = parseFloat(totalFeesAmount.toFixed(4));
            
            document.getElementById('targetProgress').innerHTML = targetPrice > 0 ? 
                `${parseFloat(targetProgress.toFixed(1))}<span class="unit">%</span>` : 
                `-<span class="unit">%</span>`;
            document.getElementById('targetPrice').textContent = targetPrice > 0 ? parseFloat(targetPrice.toFixed(4)) : '-';
            
            // document.getElementById('riskLevel').textContent = riskLevel.level;
            // document.getElementById('concentrationRisk').textContent = riskLevel.concentration;

            // 更新配置显示
            document.getElementById('displayTotalFunds').textContent = parseFloat(actualTotalFunds.toFixed(4));
            document.getElementById('displayRecordedFunds').textContent = parseFloat(totalInvested.toFixed(4));
            document.getElementById('displayUnrecordedFunds').textContent = parseFloat((actualTotalFunds - totalInvested).toFixed(4));

            // 更新分银行持仓详情
            updateBankSummary();
        }

        function updateProfitOverview(totalProfitLoss, profitRate, invested, currentValue, totalFunds, remainingFunds) {
            const profitAmount = document.getElementById('totalProfitLoss');
            const profitRateElement = document.getElementById('totalProfitRate');
            const profitBadge = document.getElementById('profitBadge');
            const principalElement = document.getElementById('principalAmount');
            const currentValueElement = document.getElementById('currentTotalValue');
            
            // 万格式化函数
            function formatToWan(amount) {
                if (Math.abs(amount) >= 10000) {
                    return `${(amount / 10000).toFixed(2)}万`;
                } else {
                    return `${amount.toFixed(2)}`;
                }
            }
            
            // 更新金额
            profitAmount.querySelector('.amount').textContent = formatToWan(totalProfitLoss);
            profitRateElement.querySelector('.rate').textContent = `${profitRate.toFixed(2)}%`;
            
            // 更新状态标识
            if (totalProfitLoss > 0) {
                profitBadge.textContent = '盈利';
                profitBadge.className = 'profit-badge profit';
                profitAmount.style.color = '#ff3b30';
            } else if (totalProfitLoss < 0) {
                profitBadge.textContent = '亏损';
                profitBadge.className = 'profit-badge loss';
                profitAmount.style.color = '#34c759';
            } else {
                profitBadge.textContent = '持平';
                profitBadge.className = 'profit-badge neutral';
                profitAmount.style.color = 'white';
            }
            
            // 更新详细信息
            principalElement.textContent = `${formatToWan(invested)}元`;
            currentValueElement.textContent = `${formatToWan(currentValue)}元`;
            
            // 更新资金进度
            updateFundsProgress(invested, totalFunds, remainingFunds);
        }

        function updateFundsProgress(invested, totalFunds, remainingFunds) {
            const progressText = document.getElementById('fundsProgressText');
            const progressFill = document.getElementById('fundsProgressFill');
            const remainingFundsElement = document.getElementById('remainingFundsAmount');
            const usageRateElement = document.getElementById('fundsUsageRate');
            
            // 计算使用率
            const usageRate = totalFunds > 0 ? (invested / totalFunds) * 100 : 0;
            
            // 万格式化函数
            function formatToWan(amount) {
                if (amount >= 10000) {
                    return `${(amount / 10000).toFixed(2)}万`;
                } else {
                    return `${amount.toFixed(2)}`;
                }
            }
            
            // 更新进度文本
            progressText.textContent = `${formatToWan(invested)} / ${formatToWan(totalFunds)}`;
            
            // 更新进度条
            progressFill.style.width = `${Math.min(usageRate, 100)}%`;
            
            // 根据使用率调整进度条颜色
            if (usageRate >= 90) {
                progressFill.style.background = 'linear-gradient(90deg, #ff9500, #ff6347)';
            } else if (usageRate >= 70) {
                progressFill.style.background = 'linear-gradient(90deg, #ffcc02, #ff9500)';
            } else {
                progressFill.style.background = 'linear-gradient(90deg, #34c759, #30d158)';
            }
            
            // 更新详细信息
            remainingFundsElement.textContent = `${formatToWan(remainingFunds)}元`;
            usageRateElement.textContent = `${usageRate.toFixed(1)}%`;
        }

        function calculateRiskLevel(totalWeight, totalFunds) {
            if (totalFunds === 0) return { level: '无风险', concentration: '无持仓' };
            
            // 计算集中度风险（基于银行数量）
            const bankCount = [...new Set(transactions.map(t => t.bank))].length;
            let concentrationRisk = '';
            if (bankCount === 1) concentrationRisk = '高集中';
            else if (bankCount === 2) concentrationRisk = '中等集中';
            else concentrationRisk = '分散';
            
            // 计算总体风险等级
            let riskLevel = '低风险';
            if (totalFunds > 100000) riskLevel = '中风险';
            if (totalFunds > 500000) riskLevel = '高风险';
            
            return { level: riskLevel, concentration: concentrationRisk };
        }

        function updateBankSummary() {
            const bankData = {};
            const banks = ['民生银行', '民生银行(JD)', '浙商银行(JD)'];
            
            // 初始化银行数据
            banks.forEach(bank => {
                bankData[bank] = {
                    weight: 0,
                    totalCost: 0,
                    avgPrice: 0,
                    breakEvenPrice: 0,
                    currentValue: 0,
                    profitLoss: 0
                };
            });

            // 计算各银行数据
            transactions.forEach(t => {
                if (bankData[t.bank]) {
                    bankData[t.bank].weight += t.weight;
                    if (t.type === 'buy') {
                        bankData[t.bank].totalCost += t.amount;
                    }
                }
            });

            // 计算均价和保本均价
            Object.keys(bankData).forEach(bank => {
                const data = bankData[bank];
                if (data.weight > 0) {
                    data.avgPrice = data.totalCost / data.weight;
                    
                    // 不同银行的保本均价
                    if (bank === '民生银行') {
                        data.breakEvenPrice = data.avgPrice + 3; // 3元每克
                    } else if (bank.includes('(JD)')) {
                        data.breakEvenPrice = data.avgPrice / (1 - 0.004); // 千分之四手续费
                    }
                    
                    data.currentValue = data.weight * currentGoldPrice;
                    data.profitLoss = data.currentValue - data.totalCost;
                }
            });

            // 渲染表格
            const tbody = document.getElementById('bankSummaryTable');
            tbody.innerHTML = '';

            // 检查是否有持仓数据
            const hasPositions = Object.values(bankData).some(data => data.weight > 0);
            
            if (hasPositions) {
                Object.keys(bankData).forEach(bank => {
                    const data = bankData[bank];
                    if (data.weight > 0) {
                        const row = tbody.insertRow();
                        const profitClass = data.profitLoss >= 0 ? 'profit-positive' : 'profit-negative';
                        row.innerHTML = `
                            <td>${bank}</td>
                            <td>${parseFloat(data.weight.toFixed(4))}</td>
                            <td>${parseFloat(data.avgPrice.toFixed(4))}</td>
                            <td>${parseFloat(data.breakEvenPrice.toFixed(4))}</td>
                            <td>${parseFloat(data.currentValue.toFixed(4))}</td>
                            <td class="${profitClass}">${parseFloat(data.profitLoss.toFixed(4))}</td>
                        `;
                    }
                });
            } else {
                // 显示空状态提示
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td colspan="6" style="text-align: center; color: #86868b; padding: 30px; font-style: italic;">
                        暂无持仓记录，请先添加买入交易
                    </td>
                `;
            }
        }

        function updateTotalFunds() {
            totalFunds = parseFloat(document.getElementById('modalTotalFunds').value) || 0;
            localStorage.setItem('totalFunds', totalFunds);
            updateSummary();
        }

        function updateCurrentPrice() {
            currentGoldPrice = parseFloat(document.getElementById('modalCurrentGoldPrice').value) || 520;
            localStorage.setItem('currentGoldPrice', currentGoldPrice);
            updateSummary();
        }

        function updateTargetPrice() {
            targetPrice = parseFloat(document.getElementById('modalTargetPrice').value) || 0;
            localStorage.setItem('targetPrice', targetPrice);
            updateSummary();
        }

        function openConfigModal() {
            document.getElementById('modalCurrentGoldPrice').value = currentGoldPrice;
            document.getElementById('modalTotalFunds').value = totalFunds;
            document.getElementById('modalTargetPrice').value = targetPrice;
            document.getElementById('configModal').style.display = 'block';
        }

        function closeConfigModal() {
            document.getElementById('configModal').style.display = 'none';
        }

        // 点击弹窗外部关闭弹窗
        window.onclick = function(event) {
            const modal = document.getElementById('configModal');
            if (event.target === modal) {
                closeConfigModal();
            }
        }

        function clearForm() {
            document.getElementById('weight').value = '';
            document.getElementById('price').value = '';
        }

        function saveData() {
            localStorage.setItem('goldTransactions', JSON.stringify(transactions));
        }
    </script>
</body>
</html>
