<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>积存金交易记录</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f7;
            color: #1d1d1f;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 28px;
            color: #1d1d1f;
            margin: 0;
        }

        /* 核心盈亏面板样式 */
        .profit-overview {
            margin-bottom: 30px;
        }

        .profit-main-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 16px;
            padding: 30px;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .profit-main-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            pointer-events: none;
        }

        .profit-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .profit-header h2 {
            font-size: 18px;
            font-weight: 600;
            margin: 0;
        }

        .profit-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            backdrop-filter: blur(10px);
        }

        .profit-badge.profit { background: rgba(255, 59, 48, 0.8); }
        .profit-badge.loss { background: rgba(52, 199, 89, 0.8); }
        .profit-badge.neutral { background: rgba(255, 255, 255, 0.2); }

        .profit-amount {
            display: flex;
            align-items: baseline;
            margin-bottom: 10px;
        }

        .profit-amount .amount {
            font-size: 36px;
            font-weight: 700;
            margin-right: 8px;
        }

        .profit-amount .unit {
            font-size: 18px;
            opacity: 0.8;
        }

        .profit-rate {
            margin-bottom: 20px;
        }

        .profit-rate .rate {
            font-size: 20px;
            font-weight: 600;
            margin-right: 8px;
        }

        .profit-rate .desc {
            font-size: 14px;
            opacity: 0.8;
        }

        .profit-detail {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px 20px;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .detail-item .label {
            font-size: 12px;
            opacity: 0.7;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .detail-item .value {
            font-size: 16px;
            font-weight: 600;
        }

        .funds-progress {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .progress-label {
            font-size: 12px;
            opacity: 0.7;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .progress-text {
            font-size: 14px;
            font-weight: 600;
        }

        .progress-bar {
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #34c759, #30d158);
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .progress-detail {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            opacity: 0.8;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .sub-value {
            font-size: 12px;
            color: #86868b;
            margin-top: 5px;
        }

        .summary-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .summary-card h3 {
            font-size: 14px;
            color: #86868b;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .summary-card .value {
            font-size: 24px;
            font-weight: 600;
            color: #1d1d1f;
        }

        .summary-card .unit {
            font-size: 14px;
            color: #86868b;
            margin-left: 4px;
        }

        .profit-positive { color: #ff3b30; }
        .profit-negative { color: #34c759; }

        .section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .section h2 {
            font-size: 20px;
            margin-bottom: 20px;
            color: #1d1d1f;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            align-items: end;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-size: 14px;
            color: #86868b;
            margin-bottom: 5px;
        }

        .form-group input, .form-group select {
            padding: 12px;
            border: 1px solid #d2d2d7;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #007aff;
        }

        .btn {
            background: #007aff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.2s;
            touch-action: manipulation; /* 防止双击缩放 */
            -webkit-tap-highlight-color: transparent; /* 去除点击高亮 */
        }

        .btn:hover {
            background: #0056b3;
        }

        .btn-danger {
            background: #ff3b30;
        }

        .btn-danger:hover {
            background: #d70015;
        }

        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch; /* iOS平滑滚动 */
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #d2d2d7;
        }

        th {
            background: #f5f5f7;
            font-weight: 600;
            color: #1d1d1f;
        }

        .type-buy {
            color: #ff3b30;
            font-weight: 600;
        }

        .type-sell {
            color: #34c759;
            font-weight: 600;
        }

        .delete-btn {
            background: none;
            border: none;
            color: #ff3b30;
            cursor: pointer;
            font-size: 16px;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background 0.2s;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            min-height: 44px; /* iOS推荐的最小触摸区域 */
            min-width: 44px;
        }

        .delete-btn:hover {
            background: rgba(255, 59, 48, 0.1);
        }

        /* 移动端适配 */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .header {
                margin-bottom: 20px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                flex-wrap: wrap;
                gap: 10px;
            }

            .header h1 {
                font-size: 24px;
                margin: 0;
            }

            .btn-config {
                margin: 0;
                padding: 8px 16px;
                font-size: 14px;
            }

            .profit-main-card {
                padding: 20px;
                margin: 0 -5px;
            }

            .profit-amount .amount {
                font-size: 28px;
            }

            .profit-detail {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .funds-progress {
                margin-top: 15px;
                padding-top: 15px;
            }

            .progress-detail {
                flex-direction: column;
                gap: 4px;
                align-items: flex-start;
            }

            .summary-grid {
                grid-template-columns: 1fr 1fr;
                gap: 15px;
            }

            .summary-card {
                padding: 15px;
            }

            .summary-card h3 {
                font-size: 12px;
            }

            .summary-card .value {
                font-size: 18px;
            }

            .sub-value {
                font-size: 10px;
            }

            .form-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .section {
                padding: 20px;
                margin-bottom: 20px;
            }

            .section h2 {
                font-size: 18px;
                margin-bottom: 15px;
            }

                         /* 表格移动端优化 */
            .table-container {
                overflow-x: auto;
                margin: 0 -20px;
                padding: 0 20px;
                position: relative;
            }

            .table-container::after {
                content: '← 滑动查看更多 →';
                position: absolute;
                bottom: -25px;
                left: 50%;
                transform: translateX(-50%);
                font-size: 12px;
                color: #86868b;
                white-space: nowrap;
            }

            table {
                min-width: 900px;
                font-size: 14px;
            }

            th, td {
                padding: 8px 6px;
                white-space: nowrap;
            }

            th {
                font-size: 12px;
            }

            /* 删除按钮移动端优化 */
            .delete-btn {
                font-size: 14px;
                padding: 2px 6px;
            }

            /* 弹窗移动端优化 */
            .modal-content {
                margin: 10% auto;
                width: 95%;
                max-width: none;
                padding: 20px;
                max-height: 80vh;
                overflow-y: auto;
            }

            .modal-header h3 {
                font-size: 18px;
            }

            .config-section {
                margin-bottom: 20px;
            }

            .config-section h4 {
                font-size: 14px;
            }

            .form-group input, .form-group select {
                padding: 10px;
                font-size: 16px; /* 防止iOS缩放 */
            }

            .btn {
                padding: 10px 20px;
                font-size: 14px;
                width: 100%;
            }

            .config-info {
                padding: 12px;
                font-size: 12px;
            }
        }

        /* 超小屏幕适配 */
        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }

            .header {
                flex-direction: column;
                align-items: stretch;
                text-align: center;
                gap: 15px;
            }

            .btn-config {
                width: 100%;
            }

            .summary-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .profit-main-card {
                margin: 0;
                padding: 15px;
            }

            .profit-amount .amount {
                font-size: 24px;
            }

            .profit-header h2 {
                font-size: 16px;
            }

            .detail-item .value {
                font-size: 14px;
            }

            .section {
                padding: 15px;
                margin-bottom: 15px;
            }

            .table-container {
                margin: 0 -15px;
                padding: 0 15px;
            }

            table {
                min-width: 800px;
                font-size: 12px;
            }

            th, td {
                padding: 6px 4px;
            }

            .modal-content {
                margin: 5% auto;
                padding: 15px;
                width: 98%;
                max-height: 90vh;
                overflow-y: auto;
            }

            /* 移动端Switch适配 */
            .switch-container {
                padding: 15px 0;
            }

            .switch-label {
                font-size: 14px;
            }

            .switch {
                width: 45px;
                height: 25px;
            }

            .slider:before {
                height: 19px;
                width: 19px;
                left: 3px;
                bottom: 3px;
            }

            input:checked + .slider:before {
                transform: translateX(20px);
            }

            /* 配置网格移动端适配 */
            .config-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            #bankPricesGrid {
                grid-template-columns: 1fr;
            }

            .config-item {
                padding: 12px;
            }

            .config-item-title {
                font-size: 12px;
            }

            .config-item-value {
                font-size: 14px;
            }

            .status-indicator {
                font-size: 12px;
            }

            .status-dot {
                width: 6px;
                height: 6px;
            }

            .quick-actions {
                flex-direction: column;
                gap: 8px;
            }

            .btn-small {
                padding: 10px 16px;
                font-size: 13px;
            }
        }

        /* 弹窗样式 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #d2d2d7;
        }

        .modal-header h3 {
            font-size: 20px;
            color: #1d1d1f;
            margin: 0;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            color: #86868b;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.2s;
        }

        .close-btn:hover {
            background: rgba(134, 134, 139, 0.1);
        }

        .config-section {
            margin-bottom: 25px;
        }

        .config-section:last-child {
            margin-bottom: 0;
        }

        .config-section h4 {
            font-size: 16px;
            color: #1d1d1f;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid #f5f5f7;
        }

        .config-info {
            margin-top: 15px;
            padding: 15px;
            background: #f5f5f7;
            border-radius: 8px;
            font-size: 14px;
            color: #86868b;
        }

        .btn-config {
            background: #34c759;
            margin-left: auto;
            margin-right: 20px;
        }

        .btn-config:hover {
            background: #28a745;
        }

        /* 新增样式 */
        .price-status {
            font-size: 14px;
            font-weight: 600;
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 10px;
        }

        .price-status.success {
            background-color: #e8f5e9;
            color: #2e7d32;
        }

        .price-status.error {
            background-color: #ffebee;
            color: #c62828;
        }

        .price-status.running {
            background-color: #e3f2fd;
            color: #1976d2;
        }

        .price-status.stopped {
            background-color: #f3e5f5;
            color: #880e4f;
        }

        .price-status.loading {
            background-color: #fff3e0;
            color: #ef6c00;
        }

        .last-update-time {
            font-size: 13px;
            color: #86868b;
            margin-bottom: 10px;
            text-align: center;
        }

        .price-status-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #f5f5f7;
        }



        /* Switch开关样式 */
        .switch-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            padding: 12px 0;
        }

        .switch-label {
            font-size: 16px;
            font-weight: 600;
            color: #1d1d1f;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #d2d2d7;
            transition: .3s;
            border-radius: 14px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        input:checked + .slider {
            background-color: #34c759;
        }

        input:checked + .slider:before {
            transform: translateX(22px);
        }

        input:focus + .slider {
            box-shadow: 0 0 1px #34c759;
        }

        /* 配置区块样式优化 */
        .config-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .config-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #e9ecef;
        }

        .config-item-title {
            font-size: 14px;
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .config-item-value {
            font-size: 16px;
            font-weight: 600;
            color: #1d1d1f;
        }

        .config-divider {
            height: 1px;
            background: linear-gradient(90deg, transparent, #d2d2d7, transparent);
            margin: 25px 0;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #86868b;
        }

        .status-dot.active {
            background-color: #34c759;
            animation: pulse 2s infinite;
        }

        .status-dot.error {
            background-color: #ff3b30;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .quick-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            flex: 1;
        }

        .btn-small.secondary {
            background: #f1f3f4;
            color: #5f6368;
        }

        .btn-small.secondary:hover {
            background: #e8eaed;
        }

        /* 滑块样式 */
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #d2d2d7;
            outline: none;
            margin: 10px 0;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #007aff;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #007aff;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>积存金交易记录</h1>
            <div style="display: flex; gap: 10px;">
                <button class="btn" onclick="openAddRecordModal()">添加记录</button>
                <button class="btn" onclick="exportData()">导出数据</button>
                <button class="btn" onclick="document.getElementById('importFileInput').click()">导入数据</button>
                <input type="file" id="importFileInput" accept="application/json" style="display:none" onchange="importData(event)">
                <button class="btn btn-config" onclick="openConfigModal()">系统配置</button>
            </div>
        </div>

        <!-- 核心盈亏面板 -->
        <div class="profit-overview">
            <div class="profit-main-card">
                <div class="profit-header">
                    <h2>总盈亏状况</h2>
                    <div class="profit-badge" id="profitBadge">持平</div>
                </div>
                <div class="profit-amount" id="totalProfitLoss">
                    <span class="amount">0</span>
                    <span class="unit">元</span>
                </div>
                <div class="profit-rate" id="totalProfitRate">
                    <span class="rate">0%</span>
                    <span class="desc">总收益率</span>
                </div>
                <div class="profit-detail">
                    <div class="detail-item">
                        <span class="label">总价值</span>
                        <span class="value" id="grossTotalValue">0元</span>
                    </div>
                    <div class="detail-item">
                        <span class="label">净价值</span>
                        <span class="value" id="netTotalValue">0元</span>
                    </div>
                    <div class="detail-item">
                        <span class="label">卖出手续费</span>
                        <span class="value" id="sellFeesAmount">0元</span>
                    </div>
                    <div class="detail-item">
                        <span class="label">投入本金</span>
                        <span class="value" id="principalAmount">0元</span>
                    </div>
                </div>
                
                <div class="funds-progress">
                    <div class="progress-header">
                        <span class="progress-label">资金使用情况</span>
                        <span class="progress-text" id="fundsProgressText">0 / 0</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="fundsProgressFill"></div>
                    </div>
                    <div class="progress-detail">
                        <span>剩余: <span id="remainingFundsAmount">0元</span></span>
                        <span>使用率: <span id="fundsUsageRate">0%</span></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 详细统计面板 -->
        <div class="summary-grid">
            <div class="summary-card">
                <h3>总持仓</h3>
                <div class="value" id="totalPosition">0<span class="unit">克</span></div>
                <div class="sub-value">均价: <span id="avgPriceDisplay">0</span>元/克</div>
            </div>
            <div class="summary-card">
                <h3>保本线</h3>
                <div class="value" id="breakEvenPrice">0<span class="unit">元/克</span></div>
                <div class="sub-value" id="breakEvenStatus">需上涨: 0元/克</div>
            </div>
            <div class="summary-card">
                <h3>累计交易</h3>
                <div class="value" id="totalTrades">0<span class="unit">笔</span></div>
                <div class="sub-value">买入: <span id="buyTrades">0</span> | 卖出: <span id="sellTrades">0</span></div>
            </div>
            <div class="summary-card">
                <h3>已实现盈亏</h3>
                <div class="value" id="realizedProfitLoss">0<span class="unit">元</span></div>
                <div class="sub-value">手续费: <span id="totalFees">0</span>元</div>
            </div>
            <div class="summary-card">
                <h3>距离目标</h3>
                <div class="value" id="targetProgress">-<span class="unit">%</span></div>
                <div class="sub-value">目标价: <span id="targetPrice">-</span>元/克</div>
            </div>
        </div>

        <div class="section">
            <h2>分银行持仓详情</h2>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>银行</th>
                            <th>持仓克数</th>
                            <th>总成本</th>
                            <th>成本均价</th>
                            <th>当前价格</th>
                            <th>保本均价</th>
                            <th>总价值</th>
                            <th>手续费</th>
                            <th>净价值</th>
                            <th>未实现盈亏</th>
                            <th>历史盈亏</th>
                        </tr>
                    </thead>
                    <tbody id="bankSummaryTable">
                    </tbody>
                </table>
            </div>
        </div>

        <div class="section">
            <h2>交易记录</h2>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>日期</th>
                            <th>类型</th>
                            <th>银行</th>
                            <th>克数</th>
                            <th>单价</th>
                            <th>金额</th>
                            <th>手续费</th>
                            <th>净盈亏</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="transactionTable">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 添加记录弹窗 -->
    <div id="addRecordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>添加交易记录</h3>
                <button class="close-btn" onclick="closeAddRecordModal()">&times;</button>
            </div>
            
            <div class="config-section">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="tradeType">交易类型</label>
                        <select id="tradeType" onchange="updateBankAvgPriceInfo();onInputModeChange();calculateExpectedProfit();">
                            <option value="buy">买入</option>
                            <option value="sell">卖出</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="bank">银行</label>
                        <select id="bank" onchange="updateBankAvgPriceInfo();calculateExpectedProfit();">
                            <option value="民生银行">民生银行</option>
                            <option value="民生银行(JD)">民生银行(JD)</option>
                            <option value="浙商银行(JD)">浙商银行(JD)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="inputMode">录入方式</label>
                        <select id="inputMode" onchange="onInputModeChange()">
                            <option value="byWeight">按克数</option>
                            <option value="byAmount">按总价</option>
                        </select>
                    </div>
                    <div class="form-group" id="weightGroup">
                        <label for="weight">克数 (最多4位小数)</label>
                        <input type="number" id="weight" step="0.0001" placeholder="10.0000" oninput="onWeightOrPriceInput();calculateExpectedProfit();">
                    </div>
                    <div class="form-group" id="amountGroup" style="display:none;">
                        <label for="amount">总价 (元，最多2位小数)</label>
                        <input type="number" id="amount" step="0.01" placeholder="1000.00" oninput="onAmountOrPriceInput()">
                    </div>
                    <div class="form-group">
                        <label for="price">单价 (元/克，最多4位小数)</label>
                        <input type="number" id="price" step="0.0001" placeholder="520.0000" oninput="onWeightOrPriceInput();onAmountOrPriceInput();calculateExpectedProfit();">
                    </div>
                    <div class="form-group">
                        <label for="tradeDate">交易日期</label>
                        <input type="date" id="tradeDate">
                    </div>
                    <div class="form-group">
                        <button class="btn" onclick="addTransaction()">添加记录</button>
                    </div>
                </div>
                
                <div class="config-info">
                    <div style="font-weight: 600; margin-bottom: 8px;">添加记录说明：</div>
                    <div style="font-size: 13px;">
                        * 选择正确的银行和交易类型<br>
                        * 重量精度：最多4位小数，金额精度：最多2位小数<br>
                        * 系统会自动计算手续费（民生银行：3元/克，JD平台：千分之四）<br>
                        * 卖出时会根据该银行的买入均价自动计算净盈亏<br>
                        * 总成本 = 买入成本 - 卖出净收入，成本均价 = 总成本 ÷ 持仓克数<br>
                        * 添加后会自动更新所有统计数据
                    </div>
                    <div id="bankAvgPriceInfo" style="margin-top: 10px; padding: 8px; background: #f0f8ff; border-radius: 4px; font-size: 12px; display: none;">
                        <!-- 动态显示银行均价信息 -->
                    </div>
                    <div id="expectedProfitInfo" style="margin-top: 10px; padding: 8px; background: #f9f9f9; border-radius: 4px; font-size: 12px; display: none; border-left: 3px solid #007aff;">
                        <!-- 动态显示预期盈亏 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 配置弹窗 -->
    <div id="configModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>系统配置</h3>
                <button class="close-btn" onclick="closeConfigModal()">&times;</button>
            </div>
            
            <div class="config-section">
                <h4>🔄 自动更新设置</h4>
                
                <!-- 主开关 -->
                <div class="switch-container">
                    <span class="switch-label">启用自动更新</span>
                    <label class="switch">
                        <input type="checkbox" id="autoUpdateSwitch" onchange="toggleAutoUpdate()">
                        <span class="slider"></span>
                    </label>
                </div>
                
                <!-- 各银行价格展示 -->
                <div id="bankPricesGrid" class="config-grid">
                    <!-- 动态生成银行价格卡片 -->
                </div>
                
                <!-- 更新状态 -->
                <div class="config-item" style="grid-column: 1 / -1;">
                    <div class="config-item-title">更新状态</div>
                    <div class="status-indicator">
                        <div class="status-dot" id="priceStatusDot"></div>
                        <span id="priceStatusText">手动模式</span>
                    </div>
                    <div class="status-indicator">
                        <span id="updateIntervalDisplay">间隔: 10秒</span>
                    </div>
                </div>
                
                <!-- 详细配置 -->
                <div class="config-divider"></div>
                
                <div class="form-group">
                    <label for="modalUpdateInterval">更新间隔 (秒)</label>
                    <input type="range" id="modalUpdateInterval" min="5" max="60" step="5" value="10" 
                           oninput="updateIntervalDisplay(this.value)" onchange="updateAutoSettings()">
                    <div style="display: flex; justify-content: space-between; font-size: 12px; color: #86868b; margin-top: 5px;">
                        <span>5秒</span>
                        <span id="intervalValue">10秒</span>
                        <span>60秒</span>
                    </div>
                </div>
                
                <div class="quick-actions">
                    <button class="btn-small secondary" onclick="fetchAllBankPrices()">立即更新</button>
                    <button class="btn-small" onclick="updateCurrentPrice()">手动设置</button>
                </div>
                
                <div class="config-info">
                    <div style="font-weight: 600; margin-bottom: 8px;">说明：</div>
                    <div style="font-size: 13px;">
                        * 系统会根据您的交易记录自动获取对应银行的价格<br>
                        * 民生银行使用京东平台数据，浙商银行使用自有API<br>
                        * 价格更新会同时应用到所有相关计算中
                    </div>
                </div>
                
                <div id="lastUpdateTime" class="last-update-time"></div>
            </div>

            <div class="config-section">
                <h4>💰 手动金价设置</h4>
                <div class="form-group">
                    <label for="modalCurrentGoldPrice">当前金价 (元/克)</label>
                    <input type="number" id="modalCurrentGoldPrice" step="0.01" value="520" placeholder="520.00">
                </div>
                <button class="btn" onclick="updateCurrentPrice()">应用价格</button>
                
                <div class="config-info">
                    <div style="font-weight: 600; margin-bottom: 8px;">说明：</div>
                    <div style="font-size: 13px;">
                        * 手动设置的价格会立即生效<br>
                        * 如果启用自动更新，手动价格会被覆盖
                    </div>
                </div>
            </div>

            <div class="config-section">
                <h4>总资金配置</h4>
                <div class="form-group">
                    <label for="modalTotalFunds">总资金 (元)</label>
                    <input type="number" id="modalTotalFunds" step="0.01" placeholder="包含线下等其他投资资金">
                </div>
                <button class="btn" onclick="updateTotalFunds()">更新总资金</button>
                
                <div class="config-info">
                    <div style="font-weight: 600; margin-bottom: 8px;">资金配置说明：</div>
                    <div>
                        设置总资金：<span id="displayTotalFunds">0</span>元 | 
                        已记录投入：<span id="displayRecordedFunds">0</span>元 | 
                        未记录投入：<span id="displayUnrecordedFunds">0</span>元
                    </div>
                    <div style="margin-top: 8px; font-size: 13px;">
                        * 总资金包含所有黄金投资（线上记录 + 线下投资）<br>
                        * 用于更准确计算整体投资收益情况
                    </div>
                </div>
            </div>

            <div class="config-section">
                <h4>投资目标设置</h4>
                <div class="form-group">
                    <label for="modalTargetPrice">目标价格 (元/克)</label>
                    <input type="number" id="modalTargetPrice" step="0.01" placeholder="设置您的盈利目标价格">
                </div>
                <button class="btn" onclick="updateTargetPrice()">设置目标</button>
                
                <div class="config-info">
                    <div style="font-weight: 600; margin-bottom: 8px;">目标设置说明：</div>
                    <div style="font-size: 13px;">
                        * 设置目标价格后可查看距离目标的进度<br>
                        * 系统将根据目标计算建议操作策略
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let transactions = JSON.parse(localStorage.getItem('goldTransactions')) || [];
        let currentGoldPrice = parseFloat(localStorage.getItem('currentGoldPrice')) || 520;
        let totalFunds = parseFloat(localStorage.getItem('totalFunds')) || 0;
        let targetPrice = parseFloat(localStorage.getItem('targetPrice')) || 0;
        
        // 新增轮询相关配置
        let autoUpdateEnabled = localStorage.getItem('autoUpdateEnabled') !== 'false'; // 默认开启
        let updateInterval = parseInt(localStorage.getItem('updateInterval')) || 10; // 默认10秒
        let updateTimer = null;
        let lastUpdateTime = localStorage.getItem('lastUpdateTime') || '';
        
        // 各银行的价格数据
        let bankPrices = JSON.parse(localStorage.getItem('bankPrices')) || {
            '民生银行': { price: 520, lastUpdate: '' },
            '民生银行(JD)': { price: 520, lastUpdate: '' },
            '浙商银行(JD)': { price: 520, lastUpdate: '' }
        };

        // 首次访问时设置默认值
        if (localStorage.getItem('autoUpdateEnabled') === null) {
            localStorage.setItem('autoUpdateEnabled', 'true');
            autoUpdateEnabled = true;
        }

        // 兼容旧数据：为没有创建时间戳的交易记录补充，并标准化精度
        let needSave = false;
        transactions.forEach((transaction, index) => {
            if (!transaction.createdAt) {
                // 使用日期 + 索引作为创建时间戳
                transaction.createdAt = new Date(transaction.date).getTime() + index;
                needSave = true;
            }
            
            // 标准化数值精度
            if (transaction.weight !== undefined) {
                const newWeight = parseFloat(Math.abs(transaction.weight).toFixed(4));
                if (Math.abs(transaction.weight) !== newWeight) {
                    transaction.weight = transaction.weight < 0 ? -newWeight : newWeight;
                    needSave = true;
                }
            }
            
            if (transaction.amount !== undefined) {
                const newAmount = parseFloat(Math.abs(transaction.amount).toFixed(2));
                if (Math.abs(transaction.amount) !== newAmount) {
                    transaction.amount = transaction.amount < 0 ? -newAmount : newAmount;
                    needSave = true;
                }
            }
            
            if (transaction.price !== undefined) {
                const newPrice = parseFloat(transaction.price.toFixed(4));
                if (transaction.price !== newPrice) {
                    transaction.price = newPrice;
                    needSave = true;
                }
            }
            
            if (transaction.fee !== undefined) {
                const newFee = parseFloat(transaction.fee.toFixed(4));
                if (transaction.fee !== newFee) {
                    transaction.fee = newFee;
                    needSave = true;
                }
            }
            
            if (transaction.realizedProfitLoss !== undefined) {
                const newRealizedProfitLoss = parseFloat(transaction.realizedProfitLoss.toFixed(4));
                if (transaction.realizedProfitLoss !== newRealizedProfitLoss) {
                    transaction.realizedProfitLoss = newRealizedProfitLoss;
                    needSave = true;
                }
            }
        });
        
        // 如果有任何数据变更，保存一次数据
        if (needSave) {
            saveData();
        }
        
        // 初始化
        document.getElementById('modalCurrentGoldPrice').value = currentGoldPrice;
        document.getElementById('modalTotalFunds').value = totalFunds;
        document.getElementById('modalTargetPrice').value = targetPrice;
        document.getElementById('tradeDate').value = new Date().toISOString().split('T')[0];
        
        renderTransactions();
        updateSummary();
        
        // 启动自动更新
        if (autoUpdateEnabled) {
            startAutoUpdate();
        }
        
        // 页面加载时初始化状态显示
        updateConfigDisplay();
        updatePriceStatus(autoUpdateEnabled ? 'running' : 'stopped', 
            autoUpdateEnabled ? `自动更新运行中 (${updateInterval}秒间隔)` : '手动模式');
        

        
        // 页面卸载时清理定时器
        window.addEventListener('beforeunload', function() {
            if (updateTimer) {
                clearInterval(updateTimer);
            }
        });

        // 获取当前活跃的银行列表（有交易记录的银行）
        function getActiveBanks() {
            const activeBanks = [...new Set(transactions.map(t => t.bank))];
            return activeBanks.length > 0 ? activeBanks : ['民生银行']; // 默认至少包含民生银行
        }

        // 获取银行对应的当前价格
        function getBankPrice(bank) {
            return bankPrices[bank]?.price || currentGoldPrice || 520;
        }

        // 自动获取所有活跃银行的金价
        async function fetchAllBankPrices() {
            const activeBanks = getActiveBanks();
            let successCount = 0;
            let totalCount = 0;

            for (const bank of activeBanks) {
                totalCount++;
                try {
                    const price = await fetchBankPrice(bank);
                    if (price) {
                        successCount++;
                    }
                } catch (error) {
                    console.error(`获取${bank}价格失败:`, error);
                }
            }

            // 更新整体状态
            const currentTime = new Date().toLocaleString();
            lastUpdateTime = currentTime;
            localStorage.setItem('lastUpdateTime', lastUpdateTime);

            if (successCount > 0) {
                updatePriceStatus('success', `已更新 ${successCount}/${totalCount} 个银行价格`);
            } else {
                updatePriceStatus('error', `获取失败，请检查网络连接`);
            }

            // 更新主价格（使用第一个活跃银行的价格）
            if (activeBanks.length > 0) {
                currentGoldPrice = getBankPrice(activeBanks[0]);
                localStorage.setItem('currentGoldPrice', currentGoldPrice);
            }

            updateSummary();
            return successCount;
        }

        // 获取单个银行的价格
        async function fetchBankPrice(bank) {
            try {
                let apiUrl;
                let isMinsheng = false;

                if (bank === '民生银行' || bank === '民生银行(JD)') {
                    apiUrl = 'https://ms.jr.jd.com/gw2/generic/CreatorSer/newh5/m/getFirstRelatedProductInfo?reqData=%7B%22circleId%22%3A%2213245%22%2C%22invokeSource%22%3A5%2C%22productId%22%3A%2221001001000001%22%7D';
                    isMinsheng = true;
                } else if (bank === '浙商银行(JD)') {
                    apiUrl = 'https://api.jdjygold.com/gw2/generic/produTools/h5/m/getGoldPrice?goldCode=CZB-JCJ';
                    isMinsheng = false;
                } else {
                    throw new Error(`不支持的银行类型: ${bank}`);
                }

                // 尝试使用代理服务或直接请求，并添加时间戳header
                try {
                    // 使用 allorigins.win 的 headers 参数
                    const headersParam = encodeURIComponent(JSON.stringify({
                        'nonceStr': Date.now(),
                        'Accept': 'application/json'
                    }));
                    const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(apiUrl)}&requestHeaders=${headersParam}`;
                    
                    let response = await fetch(proxyUrl);
                    
                    if (response.ok) {
                        const proxyData = await response.json();
                        const data = JSON.parse(proxyData.contents);
                        return processBankPriceData(data, bank, isMinsheng);
                    }
                } catch (error) {
                    console.log(`AllOrigins with headers 失败:`, error.message);
                }
                throw new Error(`API请求失败: ${response.status} ${response.statusText}`);
            } catch (error) {
                console.error(`获取${bank}价格失败:`, error);
                return null;
            }
        }

        function processBankPriceData(data, bank, isMinsheng) {
            try {
                let price;

                if (isMinsheng) {
                    price = parseFloat(data.resultData?.data?.minimumPriceValue);
                } else {
                    price = parseFloat(data.resultData?.data?.lastPrice);
                }

                if (price && !isNaN(price) && price > 0) {
                    const currentTime = new Date().toLocaleString();
                    
                    // 更新银行价格数据
                    bankPrices[bank] = {
                        price: price,
                        lastUpdate: currentTime
                    };
                    
                    localStorage.setItem('bankPrices', JSON.stringify(bankPrices));
                    
                    console.log(`${bank}价格已更新: ${price}元/克`);
                    return price;
                } else {
                    throw new Error('获取到的价格数据无效或为0');
                }
            } catch (error) {
                throw new Error(`数据处理失败: ${error.message}`);
            }
        }

        function startAutoUpdate() {
            if (updateTimer) {
                clearInterval(updateTimer);
            }
            
            if (!autoUpdateEnabled) {
                updatePriceStatus('stopped', '自动更新已停止');
                return;
            }

            updatePriceStatus('loading', '正在获取最新价格...');
            
            // 立即执行一次
            fetchAllBankPrices();
            
            // 设置定时器
            updateTimer = setInterval(() => {
                fetchAllBankPrices();
            }, updateInterval * 1000);
            
            updatePriceStatus('running', `自动更新已启动 (${updateInterval}秒间隔)`);
        }

        function stopAutoUpdate() {
            if (updateTimer) {
                clearInterval(updateTimer);
                updateTimer = null;
            }
            autoUpdateEnabled = false;
            localStorage.setItem('autoUpdateEnabled', 'false');
            updatePriceStatus('stopped', '自动更新已停止');
        }

        function updatePriceStatus(status, message) {
            // 更新配置面板中的状态文本
            const statusTextElement = document.getElementById('priceStatusText');
            const statusDotElement = document.getElementById('priceStatusDot');
            
            if (statusTextElement && statusDotElement) {
                statusTextElement.textContent = message;
                
                // 更新状态点颜色
                statusDotElement.className = 'status-dot';
                switch(status) {
                    case 'success':
                    case 'running':
                        statusDotElement.classList.add('active');
                        break;
                    case 'error':
                        statusDotElement.classList.add('error');
                        break;
                    default:
                        // 默认灰色
                        break;
                }
            }
            
            const lastUpdateElement = document.getElementById('lastUpdateTime');
            if (lastUpdateElement && lastUpdateTime) {
                lastUpdateElement.textContent = `最后更新: ${lastUpdateTime}`;
            }
            

            
            // 更新配置面板显示
            updateBankPriceCards();
        }

        function toggleAutoUpdate() {
            // 从switch开关获取状态
            const switchElement = document.getElementById('autoUpdateSwitch');
            if (switchElement) {
                autoUpdateEnabled = switchElement.checked;
            } else {
                autoUpdateEnabled = !autoUpdateEnabled;
            }
            
            localStorage.setItem('autoUpdateEnabled', autoUpdateEnabled);
            
            if (autoUpdateEnabled) {
                startAutoUpdate();
            } else {
                stopAutoUpdate();
            }
            
            updateConfigDisplay();
        }

        function updateConfigDisplay() {
            // 更新switch开关状态
            const switchElement = document.getElementById('autoUpdateSwitch');
            if (switchElement) {
                switchElement.checked = autoUpdateEnabled;
            }
            
            // 更新间隔显示
            const intervalDisplay = document.getElementById('updateIntervalDisplay');
            if (intervalDisplay) {
                intervalDisplay.textContent = `间隔: ${updateInterval}秒`;
            }
            
            // 更新滑块显示
            const intervalValue = document.getElementById('intervalValue');
            if (intervalValue) {
                intervalValue.textContent = `${updateInterval}秒`;
            }
            
            // 更新银行价格卡片
            updateBankPriceCards();
        }

        function updateBankPriceCards() {
            const activeBanks = getActiveBanks();
            const bankPricesGrid = document.getElementById('bankPricesGrid');
            
            if (!bankPricesGrid) return;
            
            bankPricesGrid.innerHTML = '';
            
            activeBanks.forEach(bank => {
                const bankPrice = bankPrices[bank]?.price || 520;
                const lastUpdate = bankPrices[bank]?.lastUpdate || '';
                
                const card = document.createElement('div');
                card.className = 'config-item';
                card.innerHTML = `
                    <div class="config-item-title">${bank}</div>
                    <div class="config-item-value">¥${parseFloat(bankPrice.toFixed(2))}/克</div>
                    <div class="status-indicator">
                        <div class="status-dot ${lastUpdate ? 'active' : ''}"></div>
                        <span style="font-size: 12px; color: #86868b;">
                            ${lastUpdate ? `${lastUpdate.slice(-8)}` : '未更新'}
                        </span>
                    </div>
                `;
                
                bankPricesGrid.appendChild(card);
            });
            
            // 如果没有活跃银行，显示提示
            if (activeBanks.length === 0) {
                bankPricesGrid.innerHTML = `
                    <div class="config-item" style="grid-column: 1 / -1; text-align: center; color: #86868b;">
                        <div style="font-style: italic;">暂无交易记录，请先添加交易</div>
                    </div>
                `;
            }
        }

        function updateIntervalDisplay(value) {
            const intervalValue = document.getElementById('intervalValue');
            if (intervalValue) {
                intervalValue.textContent = `${value}秒`;
            }
        }

        function updateAutoSettings() {
            const newInterval = parseInt(document.getElementById('modalUpdateInterval').value) || 10;
            
            updateInterval = newInterval;
            
            localStorage.setItem('updateInterval', updateInterval);
            
            // 更新显示
            updateConfigDisplay();
            
            // 如果自动更新正在运行，重启以应用新设置
            if (autoUpdateEnabled) {
                startAutoUpdate();
            }
        }

        function onInputModeChange() {
            const mode = document.getElementById('inputMode').value;
            const tradeType = document.getElementById('tradeType').value;
            
            // 卖出模式下，强制使用按克数输入
            if (tradeType === 'sell') {
                document.getElementById('inputMode').value = 'byWeight';
                document.getElementById('inputMode').disabled = true;
                document.getElementById('weightGroup').style.display = '';
                document.getElementById('amountGroup').style.display = 'none';
                document.getElementById('weight').disabled = false;
                document.getElementById('amount').disabled = true;
            } else {
                document.getElementById('inputMode').disabled = false;
                if (mode === 'byWeight') {
                    document.getElementById('weightGroup').style.display = '';
                    document.getElementById('amountGroup').style.display = 'none';
                    document.getElementById('weight').disabled = false;
                    document.getElementById('amount').disabled = true;
                } else {
                    document.getElementById('weightGroup').style.display = 'none';
                    document.getElementById('amountGroup').style.display = '';
                    document.getElementById('weight').disabled = true;
                    document.getElementById('amount').disabled = false;
                }
            }
        }

        function onWeightOrPriceInput() {
            const mode = document.getElementById('inputMode').value;
            if (mode === 'byWeight') {
                const weight = parseFloat(parseFloat(document.getElementById('weight').value).toFixed(4));
                const price = parseFloat(document.getElementById('price').value);
                if (!isNaN(weight) && !isNaN(price)) {
                    // 更新输入框为标准化的重量值
                    document.getElementById('weight').value = weight;
                    document.getElementById('amount').value = (weight * price).toFixed(2);
                } else {
                    document.getElementById('amount').value = '';
                }
            }
        }

        function onAmountOrPriceInput() {
            const mode = document.getElementById('inputMode').value;
            if (mode === 'byAmount') {
                const amount = parseFloat(parseFloat(document.getElementById('amount').value).toFixed(2));
                const price = parseFloat(document.getElementById('price').value);
                if (!isNaN(amount) && !isNaN(price) && price !== 0) {
                    // 更新输入框为标准化的金额值
                    document.getElementById('amount').value = amount;
                    const weight = parseFloat((amount / price).toFixed(4));
                    document.getElementById('weight').value = weight;
                } else {
                    document.getElementById('weight').value = '';
                }
            }
        }

        // 修改addTransaction函数，支持两种买入录入方式
        function addTransaction() {
            const type = document.getElementById('tradeType').value;
            const bank = document.getElementById('bank').value;
            const price = parseFloat(document.getElementById('price').value);
            const date = document.getElementById('tradeDate').value;
            let weight, amount;
            if (type === 'buy') {
                const mode = document.getElementById('inputMode').value;
                if (mode === 'byWeight') {
                    weight = parseFloat(parseFloat(document.getElementById('weight').value).toFixed(4));
                    amount = parseFloat((weight * price).toFixed(2));
                } else {
                    amount = parseFloat(parseFloat(document.getElementById('amount').value).toFixed(2));
                    weight = parseFloat((amount / price).toFixed(4));
                }
            } else {
                weight = parseFloat(parseFloat(document.getElementById('weight').value).toFixed(4));
                amount = parseFloat((weight * price).toFixed(2));
            }

            if (!weight || !price || !date || (type === 'buy' && !amount)) {
                alert('请填写完整信息');
                return;
            }

            const fee = parseFloat(calculateFee(type, bank, weight, amount).toFixed(4));
            let realizedProfitLoss = 0;

            // 如果是卖出，计算净盈亏
            if (type === 'sell') {
                const avgPrice = calculateBankAvgPrice(bank);
                // 净盈亏 = (卖出价格 - 均价) * 重量 - 手续费
                realizedProfitLoss = parseFloat(((price - avgPrice) * weight - fee).toFixed(4));
            }

            transactions.push({
                id: Date.now(),
                type,
                bank,
                weight: type === 'sell' ? -weight : weight,
                price: parseFloat(price.toFixed(4)),
                amount: type === 'sell' ? -amount : amount,
                fee,
                date,
                realizedProfitLoss: realizedProfitLoss, // 新增字段存储净盈亏
                createdAt: Date.now() // 添加创建时间戳
            });

            saveData();
            renderTransactions();
            updateSummary();
            closeAddRecordModal(); // 关闭添加记录弹窗
        }

        function calculateFee(type, bank, weight, amount) {
            if (type === 'buy') return 0;
            
            if (bank === '民生银行') {
                return Math.abs(weight) * 3; // 3元每克
            } else if (bank.includes('(JD)')) {
                return amount * 0.004; // 千分之四
            }
            return 0;
        }

        // 计算指定银行的买入均价（用于卖出时的盈亏计算）
        function calculateBankAvgPrice(bank) {
            const bankBuyTransactions = transactions.filter(t => t.bank === bank && t.type === 'buy');
            if (bankBuyTransactions.length === 0) return 0;
            
            const totalCost = bankBuyTransactions.reduce((sum, t) => sum + t.amount, 0);
            const totalWeight = bankBuyTransactions.reduce((sum, t) => sum + t.weight, 0);
            
            return totalWeight > 0 ? totalCost / totalWeight : 0;
        }

        // 计算指定银行的当前成本均价（总成本/总重量）
        function calculateCurrentBankAvgPrice(bank) {
            const bankTransactions = transactions.filter(t => t.bank === bank);
            let totalCost = 0;
            let totalWeight = 0;
            
            bankTransactions.forEach(t => {
                totalWeight += t.weight;
                if (t.type === 'buy') {
                    totalCost += t.amount;
                } else if (t.type === 'sell') {
                    // 卖出减少总成本（减去净收入）
                    const sellNetIncome = Math.abs(t.amount) - t.fee;
                    totalCost -= sellNetIncome;
                }
            });
            
            return totalWeight > 0 ? totalCost / totalWeight : 0;
        }

        function deleteTransaction(id) {
            transactions = transactions.filter(t => t.id !== id);
            saveData();
            renderTransactions();
            updateSummary();
        }

        function renderTransactions() {
            const tbody = document.getElementById('transactionTable');
            tbody.innerHTML = '';

            transactions.slice().sort((a, b) => {
                // 优先使用创建时间戳，如果没有则使用日期
                const timeA = a.createdAt || new Date(a.date).getTime();
                const timeB = b.createdAt || new Date(b.date).getTime();
                return timeB - timeA; // 倒序排列（最新的在前）
            }).forEach(transaction => {
                const row = tbody.insertRow();
                
                // 计算净盈亏显示
                let profitLossDisplay = '-';
                let profitLossClass = '';
                if (transaction.type === 'sell') {
                    const profitLoss = transaction.realizedProfitLoss !== undefined ? 
                        transaction.realizedProfitLoss : 
                        (Math.abs(transaction.amount) - transaction.fee);
                    profitLossDisplay = parseFloat(profitLoss.toFixed(4));
                    profitLossClass = profitLoss >= 0 ? 'profit-positive' : 'profit-negative';
                }
                
                row.innerHTML = `
                    <td>${transaction.date}</td>
                    <td class="${transaction.type === 'buy' ? 'type-buy' : 'type-sell'}">
                        ${transaction.type === 'buy' ? '买入' : '卖出'}
                    </td>
                    <td>${transaction.bank}</td>
                    <td>${parseFloat(Math.abs(transaction.weight).toFixed(4))}</td>
                    <td>${parseFloat(transaction.price.toFixed(4))}</td>
                    <td>${parseFloat(Math.abs(transaction.amount).toFixed(4))}</td>
                    <td>${parseFloat(transaction.fee.toFixed(4))}</td>
                    <td class="${profitLossClass}">${profitLossDisplay}</td>
                    <td><button class="delete-btn" onclick="deleteTransaction(${transaction.id})">删除</button></td>
                `;
            });
        }

        function updateSummary() {
            // 基础数据计算
            const recordedWeight = transactions.reduce((sum, t) => sum + t.weight, 0);
            const totalBuyAmount = transactions.filter(t => t.type === 'buy').reduce((sum, t) => sum + t.amount, 0);
            const totalSellAmount = Math.abs(transactions.filter(t => t.type === 'sell').reduce((sum, t) => sum + t.amount, 0));
            const historicalSellFees = transactions.filter(t => t.type === 'sell').reduce((sum, t) => sum + t.fee, 0);
            const totalSellNetIncome = totalSellAmount - historicalSellFees; // 卖出净收入
            const totalInvested = totalBuyAmount - totalSellNetIncome; // 净投入资金 = 买入金额 - 卖出净收入
            const totalFeesAmount = transactions.reduce((sum, t) => sum + t.fee, 0);
            const buyTransactions = transactions.filter(t => t.type === 'buy').length;
            const sellTransactions = transactions.filter(t => t.type === 'sell').length;
            
            // 计算总体统计
            let totalRemainingCost = 0;
            let totalRemainingWeight = 0;
            
            // 计算所有银行的总成本和总重量
            transactions.forEach(t => {
                totalRemainingWeight += t.weight;
                if (t.type === 'buy') {
                    totalRemainingCost += t.amount;
                } else if (t.type === 'sell') {
                    // 卖出减少总成本（减去净收入）
                    const sellNetIncome = Math.abs(t.amount) - t.fee;
                    totalRemainingCost -= sellNetIncome;
                }
            });
            
            const avgPrice = totalRemainingWeight > 0 ? totalRemainingCost / totalRemainingWeight : 0;
            const actualTotalFunds = totalFunds || totalInvested;
            
            // 总持仓就是记录的实际持仓重量
            const actualTotalWeight = recordedWeight;
            
            // 重新设计价值计算：总价值、净价值、手续费
            let grossValue = 0;  // 总价值（不考虑手续费）
            let totalSellFees = 0;  // 全部卖出需要的手续费
            const bankWeights = {};
            
            // 计算各银行的持仓重量
            transactions.forEach(t => {
                if (!bankWeights[t.bank]) bankWeights[t.bank] = 0;
                bankWeights[t.bank] += t.weight;
            });
            
            // 计算总价值和卖出手续费
            Object.keys(bankWeights).forEach(bank => {
                if (bankWeights[bank] > 0) {
                    const bankPrice = getBankPrice(bank);
                    const bankGrossValue = bankWeights[bank] * bankPrice;
                    grossValue += bankGrossValue;
                    
                    // 计算如果现在全部卖出这个银行的黄金需要的手续费
                    if (bank === '民生银行') {
                        totalSellFees += bankWeights[bank] * 3; // 3元每克
                    } else if (bank.includes('(JD)')) {
                        totalSellFees += bankGrossValue * 0.004; // 千分之四
                    }
                }
            });
            
            // 净价值 = 总价值 - 卖出手续费
            const netValue = grossValue - totalSellFees;
            const currentValue = netValue; // 使用净价值作为当前价值
            
            // 剩余资金 = 总资金 - 净投入资金
            const remainingFunds = actualTotalFunds - totalInvested;
            
            // 总盈亏 = 当前价值 - 净投入资金
            const totalProfitLoss = currentValue - totalInvested;
            const profitRate = totalInvested > 0 ? (totalProfitLoss / totalInvested) * 100 : 0;
            
            // 计算加权平均保本均价（使用总成本法）
            let breakEvenPrice = 0;
            let totalBreakEvenValue = 0;
            let totalWeight = 0;
            
            Object.keys(bankWeights).forEach(bank => {
                if (bankWeights[bank] > 0) {
                    // 使用总成本法计算成本均价
                    const bankCurrentAvgPrice = calculateCurrentBankAvgPrice(bank);
                    
                    let bankBreakEvenPrice = 0;
                    if (bank === '民生银行') {
                        bankBreakEvenPrice = bankCurrentAvgPrice + 3; // 3元每克
                    } else if (bank.includes('(JD)')) {
                        bankBreakEvenPrice = bankCurrentAvgPrice / (1 - 0.004); // 千分之四手续费
                    } else {
                        bankBreakEvenPrice = bankCurrentAvgPrice;
                    }
                    
                    totalBreakEvenValue += bankBreakEvenPrice * bankWeights[bank];
                    totalWeight += bankWeights[bank];
                }
            });
            
            if (totalWeight > 0) {
                breakEvenPrice = totalBreakEvenValue / totalWeight;
            }
            
            // 计算已实现盈亏（使用新的净盈亏字段）
            const realizedProfitLoss = transactions
                .filter(t => t.type === 'sell')
                .reduce((sum, t) => {
                    // 兼容旧数据：如果没有realizedProfitLoss字段，使用旧计算方法
                    if (t.realizedProfitLoss !== undefined) {
                        return sum + t.realizedProfitLoss;
                    } else {
                        // 旧数据兼容：简单的卖出金额减去手续费
                        return sum + Math.abs(t.amount) - t.fee;
                    }
                }, 0);
            
            // 计算风险等级
            const riskLevel = calculateRiskLevel(actualTotalWeight, actualTotalFunds);
            
            // 计算目标进度
            let targetProgress = 0;
            if (targetPrice > 0 && currentGoldPrice > 0) {
                targetProgress = ((currentGoldPrice - breakEvenPrice) / (targetPrice - breakEvenPrice)) * 100;
            }

            // 更新核心盈亏面板
            updateProfitOverview(totalProfitLoss, profitRate, totalInvested, grossValue, netValue, totalSellFees, actualTotalFunds, remainingFunds);
            
            // 更新详细统计
            document.getElementById('totalPosition').innerHTML = `${parseFloat(actualTotalWeight.toFixed(4))}<span class="unit">克</span>`;
            document.getElementById('avgPriceDisplay').textContent = parseFloat(avgPrice.toFixed(4));
            
            document.getElementById('breakEvenPrice').innerHTML = `${parseFloat(breakEvenPrice.toFixed(4))}<span class="unit">元/克</span>`;
            
            // 计算加权平均当前价格
            let weightedCurrentPrice = 0;
            if (totalWeight > 0) {
                Object.keys(bankWeights).forEach(bank => {
                    if (bankWeights[bank] > 0) {
                        const bankPrice = getBankPrice(bank);
                        weightedCurrentPrice += bankPrice * bankWeights[bank] / totalWeight;
                    }
                });
            }
            
            const breakEvenDiff = breakEvenPrice - weightedCurrentPrice;
            document.getElementById('breakEvenStatus').innerHTML = breakEvenDiff > 0 ? 
                `需上涨: ${parseFloat(breakEvenDiff.toFixed(4))}元/克` : 
                `已超过: ${parseFloat(Math.abs(breakEvenDiff).toFixed(4))}元/克`;
            
            document.getElementById('totalTrades').innerHTML = `${buyTransactions + sellTransactions}<span class="unit">笔</span>`;
            document.getElementById('buyTrades').textContent = buyTransactions;
            document.getElementById('sellTrades').textContent = sellTransactions;
            
            const realizedElement = document.getElementById('realizedProfitLoss');
            realizedElement.innerHTML = `${parseFloat(realizedProfitLoss.toFixed(4))}<span class="unit">元</span>`;
            realizedElement.className = `value ${realizedProfitLoss >= 0 ? 'profit-positive' : 'profit-negative'}`;
            document.getElementById('totalFees').textContent = parseFloat(totalFeesAmount.toFixed(4));
            
            document.getElementById('targetProgress').innerHTML = targetPrice > 0 ? 
                `${parseFloat(targetProgress.toFixed(1))}<span class="unit">%</span>` : 
                `-<span class="unit">%</span>`;
            document.getElementById('targetPrice').textContent = targetPrice > 0 ? parseFloat(targetPrice.toFixed(4)) : '-';
            
            // document.getElementById('riskLevel').textContent = riskLevel.level;
            // document.getElementById('concentrationRisk').textContent = riskLevel.concentration;

            // 更新配置显示
            document.getElementById('displayTotalFunds').textContent = parseFloat(actualTotalFunds.toFixed(4));
            document.getElementById('displayRecordedFunds').textContent = parseFloat(totalInvested.toFixed(4));
            document.getElementById('displayUnrecordedFunds').textContent = parseFloat((actualTotalFunds - totalInvested).toFixed(4));

            // 更新分银行持仓详情
            updateBankSummary();
        }

        function updateProfitOverview(totalProfitLoss, profitRate, invested, grossValue, netValue, sellFees, totalFunds, remainingFunds) {
            const profitAmount = document.getElementById('totalProfitLoss');
            const profitRateElement = document.getElementById('totalProfitRate');
            const profitBadge = document.getElementById('profitBadge');
            const principalElement = document.getElementById('principalAmount');
            const grossValueElement = document.getElementById('grossTotalValue');
            const netValueElement = document.getElementById('netTotalValue');
            const sellFeesElement = document.getElementById('sellFeesAmount');
            
            // 万格式化函数
            function formatToWan(amount) {
                if (Math.abs(amount) >= 10000) {
                    return `${(amount / 10000).toFixed(2)}万`;
                } else {
                    return `${amount.toFixed(2)}`;
                }
            }
            
            // 更新金额
            profitAmount.querySelector('.amount').textContent = formatToWan(totalProfitLoss);
            profitRateElement.querySelector('.rate').textContent = `${profitRate.toFixed(2)}%`;
            
            // 更新状态标识
            if (totalProfitLoss > 0) {
                profitBadge.textContent = '盈利';
                profitBadge.className = 'profit-badge profit';
                profitAmount.style.color = '#ff3b30';
            } else if (totalProfitLoss < 0) {
                profitBadge.textContent = '亏损';
                profitBadge.className = 'profit-badge loss';
                profitAmount.style.color = '#34c759';
            } else {
                profitBadge.textContent = '持平';
                profitBadge.className = 'profit-badge neutral';
                profitAmount.style.color = 'white';
            }
            
            // 更新详细信息
            principalElement.textContent = `${formatToWan(invested)}元`;
            grossValueElement.textContent = `${formatToWan(grossValue)}元`;
            netValueElement.textContent = `${formatToWan(netValue)}元`;
            sellFeesElement.textContent = `${formatToWan(sellFees)}元`;
            
            // 更新资金进度
            updateFundsProgress(invested, totalFunds, remainingFunds);
        }

        function updateFundsProgress(invested, totalFunds, remainingFunds) {
            const progressText = document.getElementById('fundsProgressText');
            const progressFill = document.getElementById('fundsProgressFill');
            const remainingFundsElement = document.getElementById('remainingFundsAmount');
            const usageRateElement = document.getElementById('fundsUsageRate');
            
            // 计算使用率
            const usageRate = totalFunds > 0 ? (invested / totalFunds) * 100 : 0;
            
            // 万格式化函数
            function formatToWan(amount) {
                if (amount >= 10000) {
                    return `${(amount / 10000).toFixed(2)}万`;
                } else {
                    return `${amount.toFixed(2)}`;
                }
            }
            
            // 更新进度文本
            progressText.textContent = `${formatToWan(invested)} / ${formatToWan(totalFunds)}`;
            
            // 更新进度条
            progressFill.style.width = `${Math.min(usageRate, 100)}%`;
            
            // 根据使用率调整进度条颜色
            if (usageRate >= 90) {
                progressFill.style.background = 'linear-gradient(90deg, #ff9500, #ff6347)';
            } else if (usageRate >= 70) {
                progressFill.style.background = 'linear-gradient(90deg, #ffcc02, #ff9500)';
            } else {
                progressFill.style.background = 'linear-gradient(90deg, #34c759, #30d158)';
            }
            
            // 更新详细信息
            remainingFundsElement.textContent = `${formatToWan(remainingFunds)}元`;
            usageRateElement.textContent = `${usageRate.toFixed(1)}%`;
        }

        function calculateRiskLevel(totalWeight, totalFunds) {
            if (totalFunds === 0) return { level: '无风险', concentration: '无持仓' };
            
            // 计算集中度风险（基于银行数量）
            const bankCount = [...new Set(transactions.map(t => t.bank))].length;
            let concentrationRisk = '';
            if (bankCount === 1) concentrationRisk = '高集中';
            else if (bankCount === 2) concentrationRisk = '中等集中';
            else concentrationRisk = '分散';
            
            // 计算总体风险等级
            let riskLevel = '低风险';
            if (totalFunds > 100000) riskLevel = '中风险';
            if (totalFunds > 500000) riskLevel = '高风险';
            
            return { level: riskLevel, concentration: concentrationRisk };
        }

        function updateBankSummary() {
            const bankData = {};
            const banks = ['民生银行', '民生银行(JD)', '浙商银行(JD)'];
            
            // 初始化银行数据
            banks.forEach(bank => {
                bankData[bank] = {
                    weight: 0,
                    totalCost: 0,       // 总成本（买入成本-卖出净收入）
                    avgPrice: 0,        // 成本均价
                    breakEvenPrice: 0,
                    grossValue: 0,      // 总价值
                    sellFee: 0,         // 手续费
                    netValue: 0,        // 净价值
                    profitLoss: 0,      // 未实现盈亏
                    historicalProfitLoss: 0  // 历史盈亏
                };
            });

            // 计算各银行数据
            transactions.forEach(t => {
                if (bankData[t.bank]) {
                    bankData[t.bank].weight += t.weight;
                    if (t.type === 'buy') {
                        // 买入增加总成本
                        bankData[t.bank].totalCost += t.amount;
                    } else if (t.type === 'sell') {
                        // 卖出减少总成本（减去净收入：卖出金额-手续费）
                        const sellNetIncome = Math.abs(t.amount) - t.fee;
                        bankData[t.bank].totalCost -= sellNetIncome;
                        
                        // 累计历史盈亏
                        if (t.realizedProfitLoss !== undefined) {
                            bankData[t.bank].historicalProfitLoss += t.realizedProfitLoss;
                        } else {
                            // 兼容旧数据：简单计算
                            bankData[t.bank].historicalProfitLoss += sellNetIncome;
                        }
                    }
                }
            });

            // 计算均价和保本均价
            Object.keys(bankData).forEach(bank => {
                const data = bankData[bank];
                if (data.weight > 0) {
                    // 均价 = 总成本 / 当前持仓克数
                    data.avgPrice = data.totalCost / data.weight;
                    
                    // 不同银行的保本均价
                    if (bank === '民生银行') {
                        data.breakEvenPrice = data.avgPrice + 3; // 3元每克
                    } else if (bank.includes('(JD)')) {
                        data.breakEvenPrice = data.avgPrice / (1 - 0.004); // 千分之四手续费
                    }
                    
                    // 使用对应银行的价格计算总价值
                    const bankPrice = getBankPrice(bank);
                    data.grossValue = data.weight * bankPrice;
                    
                    // 计算该银行的卖出手续费
                    if (bank === '民生银行') {
                        data.sellFee = data.weight * 3; // 3元每克
                    } else if (bank.includes('(JD)')) {
                        data.sellFee = data.grossValue * 0.004; // 千分之四
                    } else {
                        data.sellFee = 0;
                    }
                    
                    // 净价值 = 总价值 - 手续费
                    data.netValue = data.grossValue - data.sellFee;
                    
                    // 盈亏 = 净价值 - 总成本
                    data.profitLoss = data.netValue - data.totalCost;
                }
            });

            // 渲染表格
            const tbody = document.getElementById('bankSummaryTable');
            tbody.innerHTML = '';

            // 检查是否有任何交易数据（包括历史）
            const hasAnyData = Object.values(bankData).some(data => data.weight !== 0 || data.historicalProfitLoss !== 0);
            
            if (hasAnyData) {
                Object.keys(bankData).forEach(bank => {
                    const data = bankData[bank];
                    // 只显示有持仓或有历史盈亏的银行
                    if (data.weight !== 0 || data.historicalProfitLoss !== 0) {
                        const row = tbody.insertRow();
                        
                        if (data.weight > 0) {
                            // 有持仓的银行：显示完整信息
                            const profitClass = data.profitLoss >= 0 ? 'profit-positive' : 'profit-negative';
                            const bankPrice = getBankPrice(bank);
                            const lastUpdate = bankPrices[bank]?.lastUpdate || '';
                            const priceStyle = lastUpdate ? 'color: #34c759; font-weight: 600;' : 'color: #86868b;';
                            const historicalProfitClass = data.historicalProfitLoss >= 0 ? 'profit-positive' : 'profit-negative';
                            
                            row.innerHTML = `
                                <td>${bank}</td>
                                <td>${parseFloat(data.weight.toFixed(4))}</td>
                                <td style="font-weight: 600; color: #007aff;">${parseFloat(data.totalCost.toFixed(4))}</td>
                                <td>${parseFloat(data.avgPrice.toFixed(4))}</td>
                                <td style="${priceStyle}">
                                    ${parseFloat(bankPrice.toFixed(4))}
                                    ${lastUpdate ? `<br><small style="font-size: 11px; color: #86868b;">${lastUpdate.slice(-8)}</small>` : '<br><small style="font-size: 11px; color: #86868b;">未更新</small>'}
                                </td>
                                <td>${parseFloat(data.breakEvenPrice.toFixed(4))}</td>
                                <td>${parseFloat(data.grossValue.toFixed(4))}</td>
                                <td style="color: #ff3b30;">${parseFloat(data.sellFee.toFixed(4))}</td>
                                <td style="font-weight: 600;">${parseFloat(data.netValue.toFixed(4))}</td>
                                <td class="${profitClass}">${parseFloat(data.profitLoss.toFixed(4))}</td>
                                <td class="${historicalProfitClass}" style="font-weight: 600;">${parseFloat(data.historicalProfitLoss.toFixed(4))}</td>
                            `;
                        } else {
                            // 无持仓但有历史盈亏的银行：只显示历史盈亏，其他全部为0
                            const historicalProfitClass = data.historicalProfitLoss >= 0 ? 'profit-positive' : 'profit-negative';
                            
                            row.innerHTML = `
                                <td>${bank}</td>
                                <td style="color: #86868b;">0</td>
                                <td style="color: #86868b;">0</td>
                                <td style="color: #86868b;">-</td>
                                <td style="color: #86868b;">-</td>
                                <td style="color: #86868b;">-</td>
                                <td style="color: #86868b;">0</td>
                                <td style="color: #86868b;">0</td>
                                <td style="color: #86868b;">0</td>
                                <td style="color: #86868b;">0</td>
                                <td class="${historicalProfitClass}" style="font-weight: 600;">${parseFloat(data.historicalProfitLoss.toFixed(4))}</td>
                            `;
                        }
                    }
                });
            } else {
                // 显示空状态提示
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td colspan="11" style="text-align: center; color: #86868b; padding: 30px; font-style: italic;">
                        暂无交易记录，请先添加交易
                    </td>
                `;
            }
        }

        function updateTotalFunds() {
            totalFunds = parseFloat(document.getElementById('modalTotalFunds').value) || 0;
            localStorage.setItem('totalFunds', totalFunds);
            updateSummary();
        }

        function updateCurrentPrice() {
            currentGoldPrice = parseFloat(document.getElementById('modalCurrentGoldPrice').value) || 520;
            localStorage.setItem('currentGoldPrice', currentGoldPrice);
            updateSummary();
        }

        function updateTargetPrice() {
            targetPrice = parseFloat(document.getElementById('modalTargetPrice').value) || 0;
            localStorage.setItem('targetPrice', targetPrice);
            updateSummary();
        }

        function openConfigModal() {
            document.getElementById('modalCurrentGoldPrice').value = currentGoldPrice;
            document.getElementById('modalTotalFunds').value = totalFunds;
            document.getElementById('modalTargetPrice').value = targetPrice;
            document.getElementById('modalUpdateInterval').value = updateInterval;
            document.getElementById('configModal').style.display = 'block';
            
            // 更新配置显示
            updateConfigDisplay();
            updatePriceStatus(autoUpdateEnabled ? 'running' : 'stopped', 
                autoUpdateEnabled ? `自动更新运行中 (${updateInterval}秒间隔)` : '手动模式');
        }

        function closeConfigModal() {
            document.getElementById('configModal').style.display = 'none';
        }

        function openAddRecordModal() {
            document.getElementById('tradeType').value = 'buy'; // 默认买入
            document.getElementById('bank').value = '民生银行'; // 默认民生银行
            document.getElementById('inputMode').value = 'byWeight';
            onInputModeChange();
            document.getElementById('weight').value = '';
            document.getElementById('amount').value = '';
            document.getElementById('price').value = '';
            document.getElementById('tradeDate').value = new Date().toISOString().split('T')[0];
            updateBankAvgPriceInfo(); // 更新银行均价信息
            document.getElementById('addRecordModal').style.display = 'block';
        }

        // 更新银行均价信息显示
        function updateBankAvgPriceInfo() {
            const tradeType = document.getElementById('tradeType').value;
            const bank = document.getElementById('bank').value;
            const infoDiv = document.getElementById('bankAvgPriceInfo');
            
            if (tradeType === 'sell') {
                const avgPrice = calculateBankAvgPrice(bank);
                const currentAvgPrice = calculateCurrentBankAvgPrice(bank);
                const bankWeight = transactions.filter(t => t.bank === bank).reduce((sum, t) => sum + t.weight, 0);
                
                if (avgPrice > 0 && bankWeight > 0) {
                    infoDiv.style.display = 'block';
                    infoDiv.innerHTML = `
                        <div style="margin-bottom: 8px;">
                            <strong>${bank}</strong> 持仓信息：
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 11px;">
                            <div>当前持仓: <span style="color: #007aff; font-weight: 600;">${parseFloat(bankWeight.toFixed(4))}克</span></div>
                            <div>买入均价: <span style="color: #007aff; font-weight: 600;">${parseFloat(avgPrice.toFixed(4))}元/克</span></div>
                            <div>成本均价: <span style="color: #007aff; font-weight: 600;">${parseFloat(currentAvgPrice.toFixed(4))}元/克</span></div>
                            <div style="color: #666;">计算基础: 总成本法</div>
                        </div>
                        <div style="margin-top: 8px; font-size: 11px; color: #666;">
                            净盈亏 = (卖出价格 - 买入均价) × 重量 - 手续费<br>
                            <small style="color: #999;">成本均价 = 总成本 ÷ 总持仓</small>
                        </div>
                    `;
                } else {
                    infoDiv.style.display = 'block';
                    infoDiv.innerHTML = `
                        <span style="color: #ff6b6b;">注意: ${bank} 暂无持仓或买入记录</span>
                    `;
                }
            } else {
                infoDiv.style.display = 'none';
            }
        }

        // 计算预期盈亏
        function calculateExpectedProfit() {
            const tradeType = document.getElementById('tradeType').value;
            const bank = document.getElementById('bank').value;
            const inputWeight = parseFloat(document.getElementById('weight').value);
            const inputPrice = parseFloat(document.getElementById('price').value);
            const expectedProfitDiv = document.getElementById('expectedProfitInfo');
            
            if (tradeType === 'sell' && inputWeight > 0 && inputPrice > 0) {
                // 使用标准化精度
                const weight = parseFloat(inputWeight.toFixed(4));
                const price = parseFloat(inputPrice.toFixed(4));
                
                const avgPrice = calculateBankAvgPrice(bank);
                const currentWeight = parseFloat(transactions.filter(t => t.bank === bank).reduce((sum, t) => sum + t.weight, 0).toFixed(4));
                
                if (avgPrice > 0 && currentWeight >= weight) {
                    const amount = parseFloat((weight * price).toFixed(2));
                    const fee = parseFloat(calculateFee('sell', bank, weight, amount).toFixed(4));
                    const expectedProfit = parseFloat(((price - avgPrice) * weight - fee).toFixed(4));
                    const profitRate = parseFloat(((price - avgPrice) / avgPrice * 100).toFixed(2));
                    
                    const profitClass = expectedProfit >= 0 ? '#34c759' : '#ff3b30';
                    const profitText = expectedProfit >= 0 ? '预期盈利' : '预期亏损';
                    
                    expectedProfitDiv.style.display = 'block';
                    expectedProfitDiv.innerHTML = `
                        <div style="font-weight: 600; margin-bottom: 6px; color: ${profitClass};">
                            📊 ${profitText}: ${parseFloat(Math.abs(expectedProfit).toFixed(4))}元
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px; font-size: 11px;">
                            <div>卖出金额: ${parseFloat(amount.toFixed(4))}元</div>
                            <div>手续费: ${parseFloat(fee.toFixed(4))}元</div>
                            <div>价差: ${parseFloat((price - avgPrice).toFixed(4))}元/克</div>
                            <div style="color: ${profitClass};">收益率: ${parseFloat(profitRate.toFixed(2))}%</div>
                        </div>
                        <div style="margin-top: 6px; font-size: 10px; color: #666;">
                            计算公式: (${price} - ${parseFloat(avgPrice.toFixed(4))}) × ${weight} - ${parseFloat(fee.toFixed(4))} = ${parseFloat(expectedProfit.toFixed(4))}
                        </div>
                    `;
                } else if (currentWeight < weight) {
                    expectedProfitDiv.style.display = 'block';
                    expectedProfitDiv.style.borderLeftColor = '#ff3b30';
                    expectedProfitDiv.innerHTML = `
                        <span style="color: #ff3b30;">⚠️ 卖出数量超过持仓 (当前持仓: ${currentWeight}克)</span>
                    `;
                } else {
                    expectedProfitDiv.style.display = 'block';
                    expectedProfitDiv.style.borderLeftColor = '#ff3b30';
                    expectedProfitDiv.innerHTML = `
                        <span style="color: #ff3b30;">⚠️ 该银行暂无持仓记录</span>
                    `;
                }
            } else {
                expectedProfitDiv.style.display = 'none';
            }
        }

        function closeAddRecordModal() {
            document.getElementById('addRecordModal').style.display = 'none';
        }

        // 点击弹窗外部关闭弹窗
        window.onclick = function(event) {
            const configModal = document.getElementById('configModal');
            const addRecordModal = document.getElementById('addRecordModal');
            if (event.target === configModal) {
                closeConfigModal();
            }
            if (event.target === addRecordModal) {
                closeAddRecordModal();
            }
        }

        function clearForm() {
            document.getElementById('weight').value = '';
            document.getElementById('price').value = '';
        }

        function saveData() {
            localStorage.setItem('goldTransactions', JSON.stringify(transactions));
        }

        // 导出数据为JSON文件
        function exportData() {
            const data = {
                transactions,
                currentGoldPrice,
                totalFunds,
                targetPrice,
                bankPrices,
                autoUpdateEnabled,
                updateInterval
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'gold_data.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // 导入JSON数据
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.transactions) {
                        transactions = data.transactions;
                        localStorage.setItem('goldTransactions', JSON.stringify(transactions));
                    }
                    if (data.currentGoldPrice) {
                        currentGoldPrice = data.currentGoldPrice;
                        localStorage.setItem('currentGoldPrice', currentGoldPrice);
                    }
                    if (data.totalFunds) {
                        totalFunds = data.totalFunds;
                        localStorage.setItem('totalFunds', totalFunds);
                    }
                    if (data.targetPrice) {
                        targetPrice = data.targetPrice;
                        localStorage.setItem('targetPrice', targetPrice);
                    }
                    if (data.bankPrices) {
                        bankPrices = data.bankPrices;
                        localStorage.setItem('bankPrices', JSON.stringify(bankPrices));
                    }
                    if (typeof data.autoUpdateEnabled !== 'undefined') {
                        autoUpdateEnabled = data.autoUpdateEnabled;
                        localStorage.setItem('autoUpdateEnabled', autoUpdateEnabled);
                    }
                    if (data.updateInterval) {
                        updateInterval = data.updateInterval;
                        localStorage.setItem('updateInterval', updateInterval);
                    }
                    renderTransactions();
                    updateSummary();
                    updateConfigDisplay();
                    alert('数据导入成功！');
                } catch (err) {
                    alert('导入失败，文件格式不正确！');
                }
            };
            reader.readAsText(file);
        }
    </script>
</body>
</html>
