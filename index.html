<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç§¯å­˜é‡‘äº¤æ˜“è®°å½•</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f7;
            color: #1d1d1f;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 28px;
            color: #1d1d1f;
            margin: 0;
        }

        /* æ ¸å¿ƒç›ˆäºé¢æ¿æ ·å¼ */
        .profit-overview {
            margin-bottom: 30px;
        }

        .profit-main-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 16px;
            padding: 30px;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .profit-main-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            pointer-events: none;
        }

        .profit-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .profit-header h2 {
            font-size: 18px;
            font-weight: 600;
            margin: 0;
        }

        .profit-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            backdrop-filter: blur(10px);
        }

        .profit-badge.profit { background: rgba(255, 59, 48, 0.8); }
        .profit-badge.loss { background: rgba(52, 199, 89, 0.8); }
        .profit-badge.neutral { background: rgba(255, 255, 255, 0.2); }

        .profit-amount {
            display: flex;
            align-items: baseline;
            margin-bottom: 10px;
        }

        .profit-amount .amount {
            font-size: 36px;
            font-weight: 700;
            margin-right: 8px;
        }

        .profit-amount .unit {
            font-size: 18px;
            opacity: 0.8;
        }

        .profit-rate {
            margin-bottom: 20px;
        }

        .profit-rate .rate {
            font-size: 20px;
            font-weight: 600;
            margin-right: 8px;
        }

        .profit-rate .desc {
            font-size: 14px;
            opacity: 0.8;
        }

        .profit-detail {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px 20px;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .detail-item .label {
            font-size: 12px;
            opacity: 0.7;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .detail-item .value {
            font-size: 16px;
            font-weight: 600;
        }

        .funds-progress {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .progress-label {
            font-size: 12px;
            opacity: 0.7;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .progress-text {
            font-size: 14px;
            font-weight: 600;
        }

        .progress-bar {
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #34c759, #30d158);
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .progress-detail {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            opacity: 0.8;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .sub-value {
            font-size: 12px;
            color: #86868b;
            margin-top: 5px;
        }

        .summary-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .summary-card h3 {
            font-size: 14px;
            color: #86868b;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .summary-card .value {
            font-size: 24px;
            font-weight: 600;
            color: #1d1d1f;
        }

        .summary-card .unit {
            font-size: 14px;
            color: #86868b;
            margin-left: 4px;
        }

        .profit-positive { color: #ff3b30; }
        .profit-negative { color: #34c759; }

        .section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .section h2 {
            font-size: 20px;
            margin-bottom: 20px;
            color: #1d1d1f;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            align-items: end;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-size: 14px;
            color: #86868b;
            margin-bottom: 5px;
        }

        .form-group input, .form-group select {
            padding: 12px;
            border: 1px solid #d2d2d7;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #007aff;
        }

        .btn {
            background: #007aff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.2s;
            touch-action: manipulation; /* é˜²æ­¢åŒå‡»ç¼©æ”¾ */
            -webkit-tap-highlight-color: transparent; /* å»é™¤ç‚¹å‡»é«˜äº® */
        }

        .btn:hover {
            background: #0056b3;
        }

        .btn-danger {
            background: #ff3b30;
        }

        .btn-danger:hover {
            background: #d70015;
        }

        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch; /* iOSå¹³æ»‘æ»šåŠ¨ */
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #d2d2d7;
        }

        th {
            background: #f5f5f7;
            font-weight: 600;
            color: #1d1d1f;
        }

        .type-buy {
            color: #ff3b30;
            font-weight: 600;
        }

        .type-sell {
            color: #34c759;
            font-weight: 600;
        }

        .delete-btn {
            background: none;
            border: none;
            color: #ff3b30;
            cursor: pointer;
            font-size: 16px;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background 0.2s;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            min-height: 44px; /* iOSæ¨èçš„æœ€å°è§¦æ‘¸åŒºåŸŸ */
            min-width: 44px;
        }

        .delete-btn:hover {
            background: rgba(255, 59, 48, 0.1);
        }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .header {
                margin-bottom: 20px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                flex-wrap: wrap;
                gap: 10px;
            }

            .header h1 {
                font-size: 24px;
                margin: 0;
            }

            .btn-config {
                margin: 0;
                padding: 8px 16px;
                font-size: 14px;
            }

            .profit-main-card {
                padding: 20px;
                margin: 0 -5px;
            }

            .profit-amount .amount {
                font-size: 28px;
            }

            .profit-detail {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .funds-progress {
                margin-top: 15px;
                padding-top: 15px;
            }

            .progress-detail {
                flex-direction: column;
                gap: 4px;
                align-items: flex-start;
            }

            .summary-grid {
                grid-template-columns: 1fr 1fr;
                gap: 15px;
            }

            .summary-card {
                padding: 15px;
            }

            .summary-card h3 {
                font-size: 12px;
            }

            .summary-card .value {
                font-size: 18px;
            }

            .sub-value {
                font-size: 10px;
            }

            .form-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .section {
                padding: 20px;
                margin-bottom: 20px;
            }

            .section h2 {
                font-size: 18px;
                margin-bottom: 15px;
            }

                         /* è¡¨æ ¼ç§»åŠ¨ç«¯ä¼˜åŒ– */
            .table-container {
                overflow-x: auto;
                margin: 0 -20px;
                padding: 0 20px;
                position: relative;
            }

            .table-container::after {
                content: 'â† æ»‘åŠ¨æŸ¥çœ‹æ›´å¤š â†’';
                position: absolute;
                bottom: -25px;
                left: 50%;
                transform: translateX(-50%);
                font-size: 12px;
                color: #86868b;
                white-space: nowrap;
            }

            table {
                min-width: 900px;
                font-size: 14px;
            }

            th, td {
                padding: 8px 6px;
                white-space: nowrap;
            }

            th {
                font-size: 12px;
            }

            /* åˆ é™¤æŒ‰é’®ç§»åŠ¨ç«¯ä¼˜åŒ– */
            .delete-btn {
                font-size: 14px;
                padding: 2px 6px;
            }

            /* å¼¹çª—ç§»åŠ¨ç«¯ä¼˜åŒ– */
            .modal-content {
                margin: 10% auto;
                width: 95%;
                max-width: none;
                padding: 20px;
                max-height: 80vh;
                overflow-y: auto;
            }

            .modal-header h3 {
                font-size: 18px;
            }

            .config-section {
                margin-bottom: 20px;
            }

            .config-section h4 {
                font-size: 14px;
            }

            .form-group input, .form-group select {
                padding: 10px;
                font-size: 16px; /* é˜²æ­¢iOSç¼©æ”¾ */
            }

            .btn {
                padding: 10px 20px;
                font-size: 14px;
                width: 100%;
            }

            .config-info {
                padding: 12px;
                font-size: 12px;
            }
        }

        /* è¶…å°å±å¹•é€‚é… */
        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }

            .header {
                flex-direction: column;
                align-items: stretch;
                text-align: center;
                gap: 15px;
            }

            .btn-config {
                width: 100%;
            }

            .summary-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .profit-main-card {
                margin: 0;
                padding: 15px;
            }

            .profit-amount .amount {
                font-size: 24px;
            }

            .profit-header h2 {
                font-size: 16px;
            }

            .detail-item .value {
                font-size: 14px;
            }

            .section {
                padding: 15px;
                margin-bottom: 15px;
            }

            .table-container {
                margin: 0 -15px;
                padding: 0 15px;
            }

            table {
                min-width: 800px;
                font-size: 12px;
            }

            th, td {
                padding: 6px 4px;
            }

            .modal-content {
                margin: 5% auto;
                padding: 15px;
                width: 98%;
                max-height: 90vh;
                overflow-y: auto;
            }

            /* ç§»åŠ¨ç«¯Switché€‚é… */
            .switch-container {
                padding: 15px 0;
            }

            .switch-label {
                font-size: 14px;
            }

            .switch {
                width: 45px;
                height: 25px;
            }

            .slider:before {
                height: 19px;
                width: 19px;
                left: 3px;
                bottom: 3px;
            }

            input:checked + .slider:before {
                transform: translateX(20px);
            }

            /* é…ç½®ç½‘æ ¼ç§»åŠ¨ç«¯é€‚é… */
            .config-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            #bankPricesGrid {
                grid-template-columns: 1fr;
            }

            .config-item {
                padding: 12px;
            }

            .config-item-title {
                font-size: 12px;
            }

            .config-item-value {
                font-size: 14px;
            }

            .status-indicator {
                font-size: 12px;
            }

            .status-dot {
                width: 6px;
                height: 6px;
            }

            .quick-actions {
                flex-direction: column;
                gap: 8px;
            }

            .btn-small {
                padding: 10px 16px;
                font-size: 13px;
            }
        }

        /* å¼¹çª—æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #d2d2d7;
        }

        .modal-header h3 {
            font-size: 20px;
            color: #1d1d1f;
            margin: 0;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            color: #86868b;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.2s;
        }

        .close-btn:hover {
            background: rgba(134, 134, 139, 0.1);
        }

        .config-section {
            margin-bottom: 25px;
        }

        .config-section:last-child {
            margin-bottom: 0;
        }

        .config-section h4 {
            font-size: 16px;
            color: #1d1d1f;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid #f5f5f7;
        }

        .config-info {
            margin-top: 15px;
            padding: 15px;
            background: #f5f5f7;
            border-radius: 8px;
            font-size: 14px;
            color: #86868b;
        }

        .btn-config {
            background: #34c759;
            margin-left: auto;
            margin-right: 20px;
        }

        .btn-config:hover {
            background: #28a745;
        }

        /* æ–°å¢æ ·å¼ */
        .price-status {
            font-size: 14px;
            font-weight: 600;
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 10px;
        }

        .price-status.success {
            background-color: #e8f5e9;
            color: #2e7d32;
        }

        .price-status.error {
            background-color: #ffebee;
            color: #c62828;
        }

        .price-status.running {
            background-color: #e3f2fd;
            color: #1976d2;
        }

        .price-status.stopped {
            background-color: #f3e5f5;
            color: #880e4f;
        }

        .price-status.loading {
            background-color: #fff3e0;
            color: #ef6c00;
        }

        .last-update-time {
            font-size: 13px;
            color: #86868b;
            margin-bottom: 10px;
            text-align: center;
        }

        .price-status-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #f5f5f7;
        }



        /* Switchå¼€å…³æ ·å¼ */
        .switch-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            padding: 12px 0;
        }

        .switch-label {
            font-size: 16px;
            font-weight: 600;
            color: #1d1d1f;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #d2d2d7;
            transition: .3s;
            border-radius: 14px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        input:checked + .slider {
            background-color: #34c759;
        }

        input:checked + .slider:before {
            transform: translateX(22px);
        }

        input:focus + .slider {
            box-shadow: 0 0 1px #34c759;
        }

        /* é…ç½®åŒºå—æ ·å¼ä¼˜åŒ– */
        .config-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .config-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #e9ecef;
        }

        .config-item-title {
            font-size: 14px;
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .config-item-value {
            font-size: 16px;
            font-weight: 600;
            color: #1d1d1f;
        }

        .config-divider {
            height: 1px;
            background: linear-gradient(90deg, transparent, #d2d2d7, transparent);
            margin: 25px 0;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #86868b;
        }

        .status-dot.active {
            background-color: #34c759;
            animation: pulse 2s infinite;
        }

        .status-dot.error {
            background-color: #ff3b30;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .quick-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            flex: 1;
        }

        .btn-small.secondary {
            background: #f1f3f4;
            color: #5f6368;
        }

        .btn-small.secondary:hover {
            background: #e8eaed;
        }

        /* æ»‘å—æ ·å¼ */
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #d2d2d7;
            outline: none;
            margin: 10px 0;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #007aff;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #007aff;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ç§¯å­˜é‡‘äº¤æ˜“è®°å½•</h1>
            <div style="display: flex; gap: 10px;">
                <button class="btn" onclick="openAddRecordModal()">æ·»åŠ è®°å½•</button>
                <button class="btn" onclick="exportData()">å¯¼å‡ºæ•°æ®</button>
                <button class="btn" onclick="document.getElementById('importFileInput').click()">å¯¼å…¥æ•°æ®</button>
                <input type="file" id="importFileInput" accept="application/json" style="display:none" onchange="importData(event)">
                <button class="btn btn-config" onclick="openConfigModal()">ç³»ç»Ÿé…ç½®</button>
            </div>
        </div>

        <!-- æ ¸å¿ƒç›ˆäºé¢æ¿ -->
        <div class="profit-overview">
            <div class="profit-main-card">
                <div class="profit-header">
                    <h2>æ€»ç›ˆäºçŠ¶å†µ</h2>
                    <div class="profit-badge" id="profitBadge">æŒå¹³</div>
                </div>
                <div class="profit-amount" id="totalProfitLoss">
                    <span class="amount">0</span>
                    <span class="unit">å…ƒ</span>
                </div>
                <div class="profit-rate" id="totalProfitRate">
                    <span class="rate">0%</span>
                    <span class="desc">æ€»æ”¶ç›Šç‡</span>
                </div>
                <div class="profit-detail">
                    <div class="detail-item">
                        <span class="label">æ€»ä»·å€¼</span>
                        <span class="value" id="grossTotalValue">0å…ƒ</span>
                    </div>
                    <div class="detail-item">
                        <span class="label">å‡€ä»·å€¼</span>
                        <span class="value" id="netTotalValue">0å…ƒ</span>
                    </div>
                    <div class="detail-item">
                        <span class="label">å–å‡ºæ‰‹ç»­è´¹</span>
                        <span class="value" id="sellFeesAmount">0å…ƒ</span>
                    </div>
                    <div class="detail-item">
                        <span class="label">æŠ•å…¥æœ¬é‡‘</span>
                        <span class="value" id="principalAmount">0å…ƒ</span>
                    </div>
                </div>
                
                <div class="funds-progress">
                    <div class="progress-header">
                        <span class="progress-label">èµ„é‡‘ä½¿ç”¨æƒ…å†µ</span>
                        <span class="progress-text" id="fundsProgressText">0 / 0</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="fundsProgressFill"></div>
                    </div>
                    <div class="progress-detail">
                        <span>å‰©ä½™: <span id="remainingFundsAmount">0å…ƒ</span></span>
                        <span>ä½¿ç”¨ç‡: <span id="fundsUsageRate">0%</span></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- è¯¦ç»†ç»Ÿè®¡é¢æ¿ -->
        <div class="summary-grid">
            <div class="summary-card">
                <h3>æ€»æŒä»“</h3>
                <div class="value" id="totalPosition">0<span class="unit">å…‹</span></div>
                <div class="sub-value">å‡ä»·: <span id="avgPriceDisplay">0</span>å…ƒ/å…‹</div>
            </div>
            <div class="summary-card">
                <h3>ä¿æœ¬çº¿</h3>
                <div class="value" id="breakEvenPrice">0<span class="unit">å…ƒ/å…‹</span></div>
                <div class="sub-value" id="breakEvenStatus">éœ€ä¸Šæ¶¨: 0å…ƒ/å…‹</div>
            </div>
            <div class="summary-card">
                <h3>ç´¯è®¡äº¤æ˜“</h3>
                <div class="value" id="totalTrades">0<span class="unit">ç¬”</span></div>
                <div class="sub-value">ä¹°å…¥: <span id="buyTrades">0</span> | å–å‡º: <span id="sellTrades">0</span></div>
            </div>
            <div class="summary-card">
                <h3>å·²å®ç°ç›ˆäº</h3>
                <div class="value" id="realizedProfitLoss">0<span class="unit">å…ƒ</span></div>
                <div class="sub-value">æ‰‹ç»­è´¹: <span id="totalFees">0</span>å…ƒ</div>
            </div>
            <div class="summary-card">
                <h3>è·ç¦»ç›®æ ‡</h3>
                <div class="value" id="targetProgress">-<span class="unit">%</span></div>
                <div class="sub-value">ç›®æ ‡ä»·: <span id="targetPrice">-</span>å…ƒ/å…‹</div>
            </div>
        </div>

        <div class="section">
            <h2>åˆ†é“¶è¡ŒæŒä»“è¯¦æƒ…</h2>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>é“¶è¡Œ</th>
                            <th>æŒä»“å…‹æ•°</th>
                            <th>æ€»æˆæœ¬</th>
                            <th>æˆæœ¬å‡ä»·</th>
                            <th>å½“å‰ä»·æ ¼</th>
                            <th>ä¿æœ¬å‡ä»·</th>
                            <th>æ€»ä»·å€¼</th>
                            <th>æ‰‹ç»­è´¹</th>
                            <th>å‡€ä»·å€¼</th>
                            <th>æœªå®ç°ç›ˆäº</th>
                            <th>å†å²ç›ˆäº</th>
                        </tr>
                    </thead>
                    <tbody id="bankSummaryTable">
                    </tbody>
                </table>
            </div>
        </div>

        <div class="section">
            <h2>äº¤æ˜“è®°å½•</h2>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>æ—¥æœŸ</th>
                            <th>ç±»å‹</th>
                            <th>é“¶è¡Œ</th>
                            <th>å…‹æ•°</th>
                            <th>å•ä»·</th>
                            <th>é‡‘é¢</th>
                            <th>æ‰‹ç»­è´¹</th>
                            <th>å‡€ç›ˆäº</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="transactionTable">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ è®°å½•å¼¹çª— -->
    <div id="addRecordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>æ·»åŠ äº¤æ˜“è®°å½•</h3>
                <button class="close-btn" onclick="closeAddRecordModal()">&times;</button>
            </div>
            
            <div class="config-section">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="tradeType">äº¤æ˜“ç±»å‹</label>
                        <select id="tradeType" onchange="updateBankAvgPriceInfo();onInputModeChange();calculateExpectedProfit();">
                            <option value="buy">ä¹°å…¥</option>
                            <option value="sell">å–å‡º</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="bank">é“¶è¡Œ</label>
                        <select id="bank" onchange="updateBankAvgPriceInfo();calculateExpectedProfit();">
                            <option value="æ°‘ç”Ÿé“¶è¡Œ">æ°‘ç”Ÿé“¶è¡Œ</option>
                            <option value="æ°‘ç”Ÿé“¶è¡Œ(JD)">æ°‘ç”Ÿé“¶è¡Œ(JD)</option>
                            <option value="æµ™å•†é“¶è¡Œ(JD)">æµ™å•†é“¶è¡Œ(JD)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="inputMode">å½•å…¥æ–¹å¼</label>
                        <select id="inputMode" onchange="onInputModeChange()">
                            <option value="byWeight">æŒ‰å…‹æ•°</option>
                            <option value="byAmount">æŒ‰æ€»ä»·</option>
                        </select>
                    </div>
                    <div class="form-group" id="weightGroup">
                        <label for="weight">å…‹æ•° (æœ€å¤š4ä½å°æ•°)</label>
                        <input type="number" id="weight" step="0.0001" placeholder="10.0000" oninput="onWeightOrPriceInput();calculateExpectedProfit();">
                    </div>
                    <div class="form-group" id="amountGroup" style="display:none;">
                        <label for="amount">æ€»ä»· (å…ƒï¼Œæœ€å¤š2ä½å°æ•°)</label>
                        <input type="number" id="amount" step="0.01" placeholder="1000.00" oninput="onAmountOrPriceInput()">
                    </div>
                    <div class="form-group">
                        <label for="price">å•ä»· (å…ƒ/å…‹ï¼Œæœ€å¤š4ä½å°æ•°)</label>
                        <input type="number" id="price" step="0.0001" placeholder="520.0000" oninput="onWeightOrPriceInput();onAmountOrPriceInput();calculateExpectedProfit();">
                    </div>
                    <div class="form-group">
                        <label for="tradeDate">äº¤æ˜“æ—¥æœŸ</label>
                        <input type="date" id="tradeDate">
                    </div>
                    <div class="form-group">
                        <button class="btn" onclick="addTransaction()">æ·»åŠ è®°å½•</button>
                    </div>
                </div>
                
                <div class="config-info">
                    <div style="font-weight: 600; margin-bottom: 8px;">æ·»åŠ è®°å½•è¯´æ˜ï¼š</div>
                    <div style="font-size: 13px;">
                        * é€‰æ‹©æ­£ç¡®çš„é“¶è¡Œå’Œäº¤æ˜“ç±»å‹<br>
                        * é‡é‡ç²¾åº¦ï¼šæœ€å¤š4ä½å°æ•°ï¼Œé‡‘é¢ç²¾åº¦ï¼šæœ€å¤š2ä½å°æ•°<br>
                        * ç³»ç»Ÿä¼šè‡ªåŠ¨è®¡ç®—æ‰‹ç»­è´¹ï¼ˆæ°‘ç”Ÿé“¶è¡Œï¼š3å…ƒ/å…‹ï¼ŒJDå¹³å°ï¼šåƒåˆ†ä¹‹å››ï¼‰<br>
                        * å–å‡ºæ—¶ä¼šæ ¹æ®è¯¥é“¶è¡Œçš„ä¹°å…¥å‡ä»·è‡ªåŠ¨è®¡ç®—å‡€ç›ˆäº<br>
                        * æ€»æˆæœ¬ = ä¹°å…¥æˆæœ¬ - å–å‡ºå‡€æ”¶å…¥ï¼Œæˆæœ¬å‡ä»· = æ€»æˆæœ¬ Ã· æŒä»“å…‹æ•°<br>
                        * æ·»åŠ åä¼šè‡ªåŠ¨æ›´æ–°æ‰€æœ‰ç»Ÿè®¡æ•°æ®
                    </div>
                    <div id="bankAvgPriceInfo" style="margin-top: 10px; padding: 8px; background: #f0f8ff; border-radius: 4px; font-size: 12px; display: none;">
                        <!-- åŠ¨æ€æ˜¾ç¤ºé“¶è¡Œå‡ä»·ä¿¡æ¯ -->
                    </div>
                    <div id="expectedProfitInfo" style="margin-top: 10px; padding: 8px; background: #f9f9f9; border-radius: 4px; font-size: 12px; display: none; border-left: 3px solid #007aff;">
                        <!-- åŠ¨æ€æ˜¾ç¤ºé¢„æœŸç›ˆäº -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- é…ç½®å¼¹çª— -->
    <div id="configModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ç³»ç»Ÿé…ç½®</h3>
                <button class="close-btn" onclick="closeConfigModal()">&times;</button>
            </div>
            
            <div class="config-section">
                <h4>ğŸ”„ è‡ªåŠ¨æ›´æ–°è®¾ç½®</h4>
                
                <!-- ä¸»å¼€å…³ -->
                <div class="switch-container">
                    <span class="switch-label">å¯ç”¨è‡ªåŠ¨æ›´æ–°</span>
                    <label class="switch">
                        <input type="checkbox" id="autoUpdateSwitch" onchange="toggleAutoUpdate()">
                        <span class="slider"></span>
                    </label>
                </div>
                
                <!-- å„é“¶è¡Œä»·æ ¼å±•ç¤º -->
                <div id="bankPricesGrid" class="config-grid">
                    <!-- åŠ¨æ€ç”Ÿæˆé“¶è¡Œä»·æ ¼å¡ç‰‡ -->
                </div>
                
                <!-- æ›´æ–°çŠ¶æ€ -->
                <div class="config-item" style="grid-column: 1 / -1;">
                    <div class="config-item-title">æ›´æ–°çŠ¶æ€</div>
                    <div class="status-indicator">
                        <div class="status-dot" id="priceStatusDot"></div>
                        <span id="priceStatusText">æ‰‹åŠ¨æ¨¡å¼</span>
                    </div>
                    <div class="status-indicator">
                        <span id="updateIntervalDisplay">é—´éš”: 10ç§’</span>
                    </div>
                </div>
                
                <!-- è¯¦ç»†é…ç½® -->
                <div class="config-divider"></div>
                
                <div class="form-group">
                    <label for="modalUpdateInterval">æ›´æ–°é—´éš” (ç§’)</label>
                    <input type="range" id="modalUpdateInterval" min="5" max="60" step="5" value="10" 
                           oninput="updateIntervalDisplay(this.value)" onchange="updateAutoSettings()">
                    <div style="display: flex; justify-content: space-between; font-size: 12px; color: #86868b; margin-top: 5px;">
                        <span>5ç§’</span>
                        <span id="intervalValue">10ç§’</span>
                        <span>60ç§’</span>
                    </div>
                </div>
                
                <div class="quick-actions">
                    <button class="btn-small secondary" onclick="fetchAllBankPrices()">ç«‹å³æ›´æ–°</button>
                    <button class="btn-small" onclick="updateCurrentPrice()">æ‰‹åŠ¨è®¾ç½®</button>
                </div>
                
                <div class="config-info">
                    <div style="font-weight: 600; margin-bottom: 8px;">è¯´æ˜ï¼š</div>
                    <div style="font-size: 13px;">
                        * ç³»ç»Ÿä¼šæ ¹æ®æ‚¨çš„äº¤æ˜“è®°å½•è‡ªåŠ¨è·å–å¯¹åº”é“¶è¡Œçš„ä»·æ ¼<br>
                        * æ°‘ç”Ÿé“¶è¡Œä½¿ç”¨äº¬ä¸œå¹³å°æ•°æ®ï¼Œæµ™å•†é“¶è¡Œä½¿ç”¨è‡ªæœ‰API<br>
                        * ä»·æ ¼æ›´æ–°ä¼šåŒæ—¶åº”ç”¨åˆ°æ‰€æœ‰ç›¸å…³è®¡ç®—ä¸­
                    </div>
                </div>
                
                <div id="lastUpdateTime" class="last-update-time"></div>
            </div>

            <div class="config-section">
                <h4>ğŸ’° æ‰‹åŠ¨é‡‘ä»·è®¾ç½®</h4>
                <div class="form-group">
                    <label for="modalCurrentGoldPrice">å½“å‰é‡‘ä»· (å…ƒ/å…‹)</label>
                    <input type="number" id="modalCurrentGoldPrice" step="0.01" value="520" placeholder="520.00">
                </div>
                <button class="btn" onclick="updateCurrentPrice()">åº”ç”¨ä»·æ ¼</button>
                
                <div class="config-info">
                    <div style="font-weight: 600; margin-bottom: 8px;">è¯´æ˜ï¼š</div>
                    <div style="font-size: 13px;">
                        * æ‰‹åŠ¨è®¾ç½®çš„ä»·æ ¼ä¼šç«‹å³ç”Ÿæ•ˆ<br>
                        * å¦‚æœå¯ç”¨è‡ªåŠ¨æ›´æ–°ï¼Œæ‰‹åŠ¨ä»·æ ¼ä¼šè¢«è¦†ç›–
                    </div>
                </div>
            </div>

            <div class="config-section">
                <h4>æ€»èµ„é‡‘é…ç½®</h4>
                <div class="form-group">
                    <label for="modalTotalFunds">æ€»èµ„é‡‘ (å…ƒ)</label>
                    <input type="number" id="modalTotalFunds" step="0.01" placeholder="åŒ…å«çº¿ä¸‹ç­‰å…¶ä»–æŠ•èµ„èµ„é‡‘">
                </div>
                <button class="btn" onclick="updateTotalFunds()">æ›´æ–°æ€»èµ„é‡‘</button>
                
                <div class="config-info">
                    <div style="font-weight: 600; margin-bottom: 8px;">èµ„é‡‘é…ç½®è¯´æ˜ï¼š</div>
                    <div>
                        è®¾ç½®æ€»èµ„é‡‘ï¼š<span id="displayTotalFunds">0</span>å…ƒ | 
                        å·²è®°å½•æŠ•å…¥ï¼š<span id="displayRecordedFunds">0</span>å…ƒ | 
                        æœªè®°å½•æŠ•å…¥ï¼š<span id="displayUnrecordedFunds">0</span>å…ƒ
                    </div>
                    <div style="margin-top: 8px; font-size: 13px;">
                        * æ€»èµ„é‡‘åŒ…å«æ‰€æœ‰é»„é‡‘æŠ•èµ„ï¼ˆçº¿ä¸Šè®°å½• + çº¿ä¸‹æŠ•èµ„ï¼‰<br>
                        * ç”¨äºæ›´å‡†ç¡®è®¡ç®—æ•´ä½“æŠ•èµ„æ”¶ç›Šæƒ…å†µ
                    </div>
                </div>
            </div>

            <div class="config-section">
                <h4>æŠ•èµ„ç›®æ ‡è®¾ç½®</h4>
                <div class="form-group">
                    <label for="modalTargetPrice">ç›®æ ‡ä»·æ ¼ (å…ƒ/å…‹)</label>
                    <input type="number" id="modalTargetPrice" step="0.01" placeholder="è®¾ç½®æ‚¨çš„ç›ˆåˆ©ç›®æ ‡ä»·æ ¼">
                </div>
                <button class="btn" onclick="updateTargetPrice()">è®¾ç½®ç›®æ ‡</button>
                
                <div class="config-info">
                    <div style="font-weight: 600; margin-bottom: 8px;">ç›®æ ‡è®¾ç½®è¯´æ˜ï¼š</div>
                    <div style="font-size: 13px;">
                        * è®¾ç½®ç›®æ ‡ä»·æ ¼åå¯æŸ¥çœ‹è·ç¦»ç›®æ ‡çš„è¿›åº¦<br>
                        * ç³»ç»Ÿå°†æ ¹æ®ç›®æ ‡è®¡ç®—å»ºè®®æ“ä½œç­–ç•¥
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let transactions = JSON.parse(localStorage.getItem('goldTransactions')) || [];
        let currentGoldPrice = parseFloat(localStorage.getItem('currentGoldPrice')) || 520;
        let totalFunds = parseFloat(localStorage.getItem('totalFunds')) || 0;
        let targetPrice = parseFloat(localStorage.getItem('targetPrice')) || 0;
        
        // æ–°å¢è½®è¯¢ç›¸å…³é…ç½®
        let autoUpdateEnabled = localStorage.getItem('autoUpdateEnabled') !== 'false'; // é»˜è®¤å¼€å¯
        let updateInterval = parseInt(localStorage.getItem('updateInterval')) || 10; // é»˜è®¤10ç§’
        let updateTimer = null;
        let lastUpdateTime = localStorage.getItem('lastUpdateTime') || '';
        
        // å„é“¶è¡Œçš„ä»·æ ¼æ•°æ®
        let bankPrices = JSON.parse(localStorage.getItem('bankPrices')) || {
            'æ°‘ç”Ÿé“¶è¡Œ': { price: 520, lastUpdate: '' },
            'æ°‘ç”Ÿé“¶è¡Œ(JD)': { price: 520, lastUpdate: '' },
            'æµ™å•†é“¶è¡Œ(JD)': { price: 520, lastUpdate: '' }
        };

        // é¦–æ¬¡è®¿é—®æ—¶è®¾ç½®é»˜è®¤å€¼
        if (localStorage.getItem('autoUpdateEnabled') === null) {
            localStorage.setItem('autoUpdateEnabled', 'true');
            autoUpdateEnabled = true;
        }

        // å…¼å®¹æ—§æ•°æ®ï¼šä¸ºæ²¡æœ‰åˆ›å»ºæ—¶é—´æˆ³çš„äº¤æ˜“è®°å½•è¡¥å……ï¼Œå¹¶æ ‡å‡†åŒ–ç²¾åº¦
        let needSave = false;
        transactions.forEach((transaction, index) => {
            if (!transaction.createdAt) {
                // ä½¿ç”¨æ—¥æœŸ + ç´¢å¼•ä½œä¸ºåˆ›å»ºæ—¶é—´æˆ³
                transaction.createdAt = new Date(transaction.date).getTime() + index;
                needSave = true;
            }
            
            // æ ‡å‡†åŒ–æ•°å€¼ç²¾åº¦
            if (transaction.weight !== undefined) {
                const newWeight = parseFloat(Math.abs(transaction.weight).toFixed(4));
                if (Math.abs(transaction.weight) !== newWeight) {
                    transaction.weight = transaction.weight < 0 ? -newWeight : newWeight;
                    needSave = true;
                }
            }
            
            if (transaction.amount !== undefined) {
                const newAmount = parseFloat(Math.abs(transaction.amount).toFixed(2));
                if (Math.abs(transaction.amount) !== newAmount) {
                    transaction.amount = transaction.amount < 0 ? -newAmount : newAmount;
                    needSave = true;
                }
            }
            
            if (transaction.price !== undefined) {
                const newPrice = parseFloat(transaction.price.toFixed(4));
                if (transaction.price !== newPrice) {
                    transaction.price = newPrice;
                    needSave = true;
                }
            }
            
            if (transaction.fee !== undefined) {
                const newFee = parseFloat(transaction.fee.toFixed(4));
                if (transaction.fee !== newFee) {
                    transaction.fee = newFee;
                    needSave = true;
                }
            }
            
            if (transaction.realizedProfitLoss !== undefined) {
                const newRealizedProfitLoss = parseFloat(transaction.realizedProfitLoss.toFixed(4));
                if (transaction.realizedProfitLoss !== newRealizedProfitLoss) {
                    transaction.realizedProfitLoss = newRealizedProfitLoss;
                    needSave = true;
                }
            }
        });
        
        // å¦‚æœæœ‰ä»»ä½•æ•°æ®å˜æ›´ï¼Œä¿å­˜ä¸€æ¬¡æ•°æ®
        if (needSave) {
            saveData();
        }
        
        // åˆå§‹åŒ–
        document.getElementById('modalCurrentGoldPrice').value = currentGoldPrice;
        document.getElementById('modalTotalFunds').value = totalFunds;
        document.getElementById('modalTargetPrice').value = targetPrice;
        document.getElementById('tradeDate').value = new Date().toISOString().split('T')[0];
        
        renderTransactions();
        updateSummary();
        
        // å¯åŠ¨è‡ªåŠ¨æ›´æ–°
        if (autoUpdateEnabled) {
            startAutoUpdate();
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–çŠ¶æ€æ˜¾ç¤º
        updateConfigDisplay();
        updatePriceStatus(autoUpdateEnabled ? 'running' : 'stopped', 
            autoUpdateEnabled ? `è‡ªåŠ¨æ›´æ–°è¿è¡Œä¸­ (${updateInterval}ç§’é—´éš”)` : 'æ‰‹åŠ¨æ¨¡å¼');
        

        
        // é¡µé¢å¸è½½æ—¶æ¸…ç†å®šæ—¶å™¨
        window.addEventListener('beforeunload', function() {
            if (updateTimer) {
                clearInterval(updateTimer);
            }
        });

        // è·å–å½“å‰æ´»è·ƒçš„é“¶è¡Œåˆ—è¡¨ï¼ˆæœ‰äº¤æ˜“è®°å½•çš„é“¶è¡Œï¼‰
        function getActiveBanks() {
            const activeBanks = [...new Set(transactions.map(t => t.bank))];
            return activeBanks.length > 0 ? activeBanks : ['æ°‘ç”Ÿé“¶è¡Œ']; // é»˜è®¤è‡³å°‘åŒ…å«æ°‘ç”Ÿé“¶è¡Œ
        }

        // è·å–é“¶è¡Œå¯¹åº”çš„å½“å‰ä»·æ ¼
        function getBankPrice(bank) {
            return bankPrices[bank]?.price || currentGoldPrice || 520;
        }

        // è‡ªåŠ¨è·å–æ‰€æœ‰æ´»è·ƒé“¶è¡Œçš„é‡‘ä»·
        async function fetchAllBankPrices() {
            const activeBanks = getActiveBanks();
            let successCount = 0;
            let totalCount = 0;

            for (const bank of activeBanks) {
                totalCount++;
                try {
                    const price = await fetchBankPrice(bank);
                    if (price) {
                        successCount++;
                    }
                } catch (error) {
                    console.error(`è·å–${bank}ä»·æ ¼å¤±è´¥:`, error);
                }
            }

            // æ›´æ–°æ•´ä½“çŠ¶æ€
            const currentTime = new Date().toLocaleString();
            lastUpdateTime = currentTime;
            localStorage.setItem('lastUpdateTime', lastUpdateTime);

            if (successCount > 0) {
                updatePriceStatus('success', `å·²æ›´æ–° ${successCount}/${totalCount} ä¸ªé“¶è¡Œä»·æ ¼`);
            } else {
                updatePriceStatus('error', `è·å–å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥`);
            }

            // æ›´æ–°ä¸»ä»·æ ¼ï¼ˆä½¿ç”¨ç¬¬ä¸€ä¸ªæ´»è·ƒé“¶è¡Œçš„ä»·æ ¼ï¼‰
            if (activeBanks.length > 0) {
                currentGoldPrice = getBankPrice(activeBanks[0]);
                localStorage.setItem('currentGoldPrice', currentGoldPrice);
            }

            updateSummary();
            return successCount;
        }

        // è·å–å•ä¸ªé“¶è¡Œçš„ä»·æ ¼
        async function fetchBankPrice(bank) {
            try {
                let apiUrl;
                let isMinsheng = false;

                if (bank === 'æ°‘ç”Ÿé“¶è¡Œ' || bank === 'æ°‘ç”Ÿé“¶è¡Œ(JD)') {
                    apiUrl = 'https://ms.jr.jd.com/gw2/generic/CreatorSer/newh5/m/getFirstRelatedProductInfo?reqData=%7B%22circleId%22%3A%2213245%22%2C%22invokeSource%22%3A5%2C%22productId%22%3A%2221001001000001%22%7D';
                    isMinsheng = true;
                } else if (bank === 'æµ™å•†é“¶è¡Œ(JD)') {
                    apiUrl = 'https://api.jdjygold.com/gw2/generic/produTools/h5/m/getGoldPrice?goldCode=CZB-JCJ';
                    isMinsheng = false;
                } else {
                    throw new Error(`ä¸æ”¯æŒçš„é“¶è¡Œç±»å‹: ${bank}`);
                }

                // å°è¯•ä½¿ç”¨ä»£ç†æœåŠ¡æˆ–ç›´æ¥è¯·æ±‚ï¼Œå¹¶æ·»åŠ æ—¶é—´æˆ³header
                try {
                    // ä½¿ç”¨ allorigins.win çš„ headers å‚æ•°
                    const headersParam = encodeURIComponent(JSON.stringify({
                        'nonceStr': Date.now(),
                        'Accept': 'application/json'
                    }));
                    const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(apiUrl)}&requestHeaders=${headersParam}`;
                    
                    let response = await fetch(proxyUrl);
                    
                    if (response.ok) {
                        const proxyData = await response.json();
                        const data = JSON.parse(proxyData.contents);
                        return processBankPriceData(data, bank, isMinsheng);
                    }
                } catch (error) {
                    console.log(`AllOrigins with headers å¤±è´¥:`, error.message);
                }
                throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}`);
            } catch (error) {
                console.error(`è·å–${bank}ä»·æ ¼å¤±è´¥:`, error);
                return null;
            }
        }

        function processBankPriceData(data, bank, isMinsheng) {
            try {
                let price;

                if (isMinsheng) {
                    price = parseFloat(data.resultData?.data?.minimumPriceValue);
                } else {
                    price = parseFloat(data.resultData?.data?.lastPrice);
                }

                if (price && !isNaN(price) && price > 0) {
                    const currentTime = new Date().toLocaleString();
                    
                    // æ›´æ–°é“¶è¡Œä»·æ ¼æ•°æ®
                    bankPrices[bank] = {
                        price: price,
                        lastUpdate: currentTime
                    };
                    
                    localStorage.setItem('bankPrices', JSON.stringify(bankPrices));
                    
                    console.log(`${bank}ä»·æ ¼å·²æ›´æ–°: ${price}å…ƒ/å…‹`);
                    return price;
                } else {
                    throw new Error('è·å–åˆ°çš„ä»·æ ¼æ•°æ®æ— æ•ˆæˆ–ä¸º0');
                }
            } catch (error) {
                throw new Error(`æ•°æ®å¤„ç†å¤±è´¥: ${error.message}`);
            }
        }

        function startAutoUpdate() {
            if (updateTimer) {
                clearInterval(updateTimer);
            }
            
            if (!autoUpdateEnabled) {
                updatePriceStatus('stopped', 'è‡ªåŠ¨æ›´æ–°å·²åœæ­¢');
                return;
            }

            updatePriceStatus('loading', 'æ­£åœ¨è·å–æœ€æ–°ä»·æ ¼...');
            
            // ç«‹å³æ‰§è¡Œä¸€æ¬¡
            fetchAllBankPrices();
            
            // è®¾ç½®å®šæ—¶å™¨
            updateTimer = setInterval(() => {
                fetchAllBankPrices();
            }, updateInterval * 1000);
            
            updatePriceStatus('running', `è‡ªåŠ¨æ›´æ–°å·²å¯åŠ¨ (${updateInterval}ç§’é—´éš”)`);
        }

        function stopAutoUpdate() {
            if (updateTimer) {
                clearInterval(updateTimer);
                updateTimer = null;
            }
            autoUpdateEnabled = false;
            localStorage.setItem('autoUpdateEnabled', 'false');
            updatePriceStatus('stopped', 'è‡ªåŠ¨æ›´æ–°å·²åœæ­¢');
        }

        function updatePriceStatus(status, message) {
            // æ›´æ–°é…ç½®é¢æ¿ä¸­çš„çŠ¶æ€æ–‡æœ¬
            const statusTextElement = document.getElementById('priceStatusText');
            const statusDotElement = document.getElementById('priceStatusDot');
            
            if (statusTextElement && statusDotElement) {
                statusTextElement.textContent = message;
                
                // æ›´æ–°çŠ¶æ€ç‚¹é¢œè‰²
                statusDotElement.className = 'status-dot';
                switch(status) {
                    case 'success':
                    case 'running':
                        statusDotElement.classList.add('active');
                        break;
                    case 'error':
                        statusDotElement.classList.add('error');
                        break;
                    default:
                        // é»˜è®¤ç°è‰²
                        break;
                }
            }
            
            const lastUpdateElement = document.getElementById('lastUpdateTime');
            if (lastUpdateElement && lastUpdateTime) {
                lastUpdateElement.textContent = `æœ€åæ›´æ–°: ${lastUpdateTime}`;
            }
            

            
            // æ›´æ–°é…ç½®é¢æ¿æ˜¾ç¤º
            updateBankPriceCards();
        }

        function toggleAutoUpdate() {
            // ä»switchå¼€å…³è·å–çŠ¶æ€
            const switchElement = document.getElementById('autoUpdateSwitch');
            if (switchElement) {
                autoUpdateEnabled = switchElement.checked;
            } else {
                autoUpdateEnabled = !autoUpdateEnabled;
            }
            
            localStorage.setItem('autoUpdateEnabled', autoUpdateEnabled);
            
            if (autoUpdateEnabled) {
                startAutoUpdate();
            } else {
                stopAutoUpdate();
            }
            
            updateConfigDisplay();
        }

        function updateConfigDisplay() {
            // æ›´æ–°switchå¼€å…³çŠ¶æ€
            const switchElement = document.getElementById('autoUpdateSwitch');
            if (switchElement) {
                switchElement.checked = autoUpdateEnabled;
            }
            
            // æ›´æ–°é—´éš”æ˜¾ç¤º
            const intervalDisplay = document.getElementById('updateIntervalDisplay');
            if (intervalDisplay) {
                intervalDisplay.textContent = `é—´éš”: ${updateInterval}ç§’`;
            }
            
            // æ›´æ–°æ»‘å—æ˜¾ç¤º
            const intervalValue = document.getElementById('intervalValue');
            if (intervalValue) {
                intervalValue.textContent = `${updateInterval}ç§’`;
            }
            
            // æ›´æ–°é“¶è¡Œä»·æ ¼å¡ç‰‡
            updateBankPriceCards();
        }

        function updateBankPriceCards() {
            const activeBanks = getActiveBanks();
            const bankPricesGrid = document.getElementById('bankPricesGrid');
            
            if (!bankPricesGrid) return;
            
            bankPricesGrid.innerHTML = '';
            
            activeBanks.forEach(bank => {
                const bankPrice = bankPrices[bank]?.price || 520;
                const lastUpdate = bankPrices[bank]?.lastUpdate || '';
                
                const card = document.createElement('div');
                card.className = 'config-item';
                card.innerHTML = `
                    <div class="config-item-title">${bank}</div>
                    <div class="config-item-value">Â¥${parseFloat(bankPrice.toFixed(2))}/å…‹</div>
                    <div class="status-indicator">
                        <div class="status-dot ${lastUpdate ? 'active' : ''}"></div>
                        <span style="font-size: 12px; color: #86868b;">
                            ${lastUpdate ? `${lastUpdate.slice(-8)}` : 'æœªæ›´æ–°'}
                        </span>
                    </div>
                `;
                
                bankPricesGrid.appendChild(card);
            });
            
            // å¦‚æœæ²¡æœ‰æ´»è·ƒé“¶è¡Œï¼Œæ˜¾ç¤ºæç¤º
            if (activeBanks.length === 0) {
                bankPricesGrid.innerHTML = `
                    <div class="config-item" style="grid-column: 1 / -1; text-align: center; color: #86868b;">
                        <div style="font-style: italic;">æš‚æ— äº¤æ˜“è®°å½•ï¼Œè¯·å…ˆæ·»åŠ äº¤æ˜“</div>
                    </div>
                `;
            }
        }

        function updateIntervalDisplay(value) {
            const intervalValue = document.getElementById('intervalValue');
            if (intervalValue) {
                intervalValue.textContent = `${value}ç§’`;
            }
        }

        function updateAutoSettings() {
            const newInterval = parseInt(document.getElementById('modalUpdateInterval').value) || 10;
            
            updateInterval = newInterval;
            
            localStorage.setItem('updateInterval', updateInterval);
            
            // æ›´æ–°æ˜¾ç¤º
            updateConfigDisplay();
            
            // å¦‚æœè‡ªåŠ¨æ›´æ–°æ­£åœ¨è¿è¡Œï¼Œé‡å¯ä»¥åº”ç”¨æ–°è®¾ç½®
            if (autoUpdateEnabled) {
                startAutoUpdate();
            }
        }

        function onInputModeChange() {
            const mode = document.getElementById('inputMode').value;
            const tradeType = document.getElementById('tradeType').value;
            
            // å–å‡ºæ¨¡å¼ä¸‹ï¼Œå¼ºåˆ¶ä½¿ç”¨æŒ‰å…‹æ•°è¾“å…¥
            if (tradeType === 'sell') {
                document.getElementById('inputMode').value = 'byWeight';
                document.getElementById('inputMode').disabled = true;
                document.getElementById('weightGroup').style.display = '';
                document.getElementById('amountGroup').style.display = 'none';
                document.getElementById('weight').disabled = false;
                document.getElementById('amount').disabled = true;
            } else {
                document.getElementById('inputMode').disabled = false;
                if (mode === 'byWeight') {
                    document.getElementById('weightGroup').style.display = '';
                    document.getElementById('amountGroup').style.display = 'none';
                    document.getElementById('weight').disabled = false;
                    document.getElementById('amount').disabled = true;
                } else {
                    document.getElementById('weightGroup').style.display = 'none';
                    document.getElementById('amountGroup').style.display = '';
                    document.getElementById('weight').disabled = true;
                    document.getElementById('amount').disabled = false;
                }
            }
        }

        function onWeightOrPriceInput() {
            const mode = document.getElementById('inputMode').value;
            if (mode === 'byWeight') {
                const weight = parseFloat(parseFloat(document.getElementById('weight').value).toFixed(4));
                const price = parseFloat(document.getElementById('price').value);
                if (!isNaN(weight) && !isNaN(price)) {
                    // æ›´æ–°è¾“å…¥æ¡†ä¸ºæ ‡å‡†åŒ–çš„é‡é‡å€¼
                    document.getElementById('weight').value = weight;
                    document.getElementById('amount').value = (weight * price).toFixed(2);
                } else {
                    document.getElementById('amount').value = '';
                }
            }
        }

        function onAmountOrPriceInput() {
            const mode = document.getElementById('inputMode').value;
            if (mode === 'byAmount') {
                const amount = parseFloat(parseFloat(document.getElementById('amount').value).toFixed(2));
                const price = parseFloat(document.getElementById('price').value);
                if (!isNaN(amount) && !isNaN(price) && price !== 0) {
                    // æ›´æ–°è¾“å…¥æ¡†ä¸ºæ ‡å‡†åŒ–çš„é‡‘é¢å€¼
                    document.getElementById('amount').value = amount;
                    const weight = parseFloat((amount / price).toFixed(4));
                    document.getElementById('weight').value = weight;
                } else {
                    document.getElementById('weight').value = '';
                }
            }
        }

        // ä¿®æ”¹addTransactionå‡½æ•°ï¼Œæ”¯æŒä¸¤ç§ä¹°å…¥å½•å…¥æ–¹å¼
        function addTransaction() {
            const type = document.getElementById('tradeType').value;
            const bank = document.getElementById('bank').value;
            const price = parseFloat(document.getElementById('price').value);
            const date = document.getElementById('tradeDate').value;
            let weight, amount;
            if (type === 'buy') {
                const mode = document.getElementById('inputMode').value;
                if (mode === 'byWeight') {
                    weight = parseFloat(parseFloat(document.getElementById('weight').value).toFixed(4));
                    amount = parseFloat((weight * price).toFixed(2));
                } else {
                    amount = parseFloat(parseFloat(document.getElementById('amount').value).toFixed(2));
                    weight = parseFloat((amount / price).toFixed(4));
                }
            } else {
                weight = parseFloat(parseFloat(document.getElementById('weight').value).toFixed(4));
                amount = parseFloat((weight * price).toFixed(2));
            }

            if (!weight || !price || !date || (type === 'buy' && !amount)) {
                alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
                return;
            }

            const fee = parseFloat(calculateFee(type, bank, weight, amount).toFixed(4));
            let realizedProfitLoss = 0;

            // å¦‚æœæ˜¯å–å‡ºï¼Œè®¡ç®—å‡€ç›ˆäº
            if (type === 'sell') {
                const avgPrice = calculateBankAvgPrice(bank);
                // å‡€ç›ˆäº = (å–å‡ºä»·æ ¼ - å‡ä»·) * é‡é‡ - æ‰‹ç»­è´¹
                realizedProfitLoss = parseFloat(((price - avgPrice) * weight - fee).toFixed(4));
            }

            transactions.push({
                id: Date.now(),
                type,
                bank,
                weight: type === 'sell' ? -weight : weight,
                price: parseFloat(price.toFixed(4)),
                amount: type === 'sell' ? -amount : amount,
                fee,
                date,
                realizedProfitLoss: realizedProfitLoss, // æ–°å¢å­—æ®µå­˜å‚¨å‡€ç›ˆäº
                createdAt: Date.now() // æ·»åŠ åˆ›å»ºæ—¶é—´æˆ³
            });

            saveData();
            renderTransactions();
            updateSummary();
            closeAddRecordModal(); // å…³é—­æ·»åŠ è®°å½•å¼¹çª—
        }

        function calculateFee(type, bank, weight, amount) {
            if (type === 'buy') return 0;
            
            if (bank === 'æ°‘ç”Ÿé“¶è¡Œ') {
                return Math.abs(weight) * 3; // 3å…ƒæ¯å…‹
            } else if (bank.includes('(JD)')) {
                return amount * 0.004; // åƒåˆ†ä¹‹å››
            }
            return 0;
        }

        // è®¡ç®—æŒ‡å®šé“¶è¡Œçš„ä¹°å…¥å‡ä»·ï¼ˆç”¨äºå–å‡ºæ—¶çš„ç›ˆäºè®¡ç®—ï¼‰
        function calculateBankAvgPrice(bank) {
            const bankBuyTransactions = transactions.filter(t => t.bank === bank && t.type === 'buy');
            if (bankBuyTransactions.length === 0) return 0;
            
            const totalCost = bankBuyTransactions.reduce((sum, t) => sum + t.amount, 0);
            const totalWeight = bankBuyTransactions.reduce((sum, t) => sum + t.weight, 0);
            
            return totalWeight > 0 ? totalCost / totalWeight : 0;
        }

        // è®¡ç®—æŒ‡å®šé“¶è¡Œçš„å½“å‰æˆæœ¬å‡ä»·ï¼ˆæ€»æˆæœ¬/æ€»é‡é‡ï¼‰
        function calculateCurrentBankAvgPrice(bank) {
            const bankTransactions = transactions.filter(t => t.bank === bank);
            let totalCost = 0;
            let totalWeight = 0;
            
            bankTransactions.forEach(t => {
                totalWeight += t.weight;
                if (t.type === 'buy') {
                    totalCost += t.amount;
                } else if (t.type === 'sell') {
                    // å–å‡ºå‡å°‘æ€»æˆæœ¬ï¼ˆå‡å»å‡€æ”¶å…¥ï¼‰
                    const sellNetIncome = Math.abs(t.amount) - t.fee;
                    totalCost -= sellNetIncome;
                }
            });
            
            return totalWeight > 0 ? totalCost / totalWeight : 0;
        }

        function deleteTransaction(id) {
            transactions = transactions.filter(t => t.id !== id);
            saveData();
            renderTransactions();
            updateSummary();
        }

        function renderTransactions() {
            const tbody = document.getElementById('transactionTable');
            tbody.innerHTML = '';

            transactions.slice().sort((a, b) => {
                // ä¼˜å…ˆä½¿ç”¨åˆ›å»ºæ—¶é—´æˆ³ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨æ—¥æœŸ
                const timeA = a.createdAt || new Date(a.date).getTime();
                const timeB = b.createdAt || new Date(b.date).getTime();
                return timeB - timeA; // å€’åºæ’åˆ—ï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
            }).forEach(transaction => {
                const row = tbody.insertRow();
                
                // è®¡ç®—å‡€ç›ˆäºæ˜¾ç¤º
                let profitLossDisplay = '-';
                let profitLossClass = '';
                if (transaction.type === 'sell') {
                    const profitLoss = transaction.realizedProfitLoss !== undefined ? 
                        transaction.realizedProfitLoss : 
                        (Math.abs(transaction.amount) - transaction.fee);
                    profitLossDisplay = parseFloat(profitLoss.toFixed(4));
                    profitLossClass = profitLoss >= 0 ? 'profit-positive' : 'profit-negative';
                }
                
                row.innerHTML = `
                    <td>${transaction.date}</td>
                    <td class="${transaction.type === 'buy' ? 'type-buy' : 'type-sell'}">
                        ${transaction.type === 'buy' ? 'ä¹°å…¥' : 'å–å‡º'}
                    </td>
                    <td>${transaction.bank}</td>
                    <td>${parseFloat(Math.abs(transaction.weight).toFixed(4))}</td>
                    <td>${parseFloat(transaction.price.toFixed(4))}</td>
                    <td>${parseFloat(Math.abs(transaction.amount).toFixed(4))}</td>
                    <td>${parseFloat(transaction.fee.toFixed(4))}</td>
                    <td class="${profitLossClass}">${profitLossDisplay}</td>
                    <td><button class="delete-btn" onclick="deleteTransaction(${transaction.id})">åˆ é™¤</button></td>
                `;
            });
        }

        function updateSummary() {
            // åŸºç¡€æ•°æ®è®¡ç®—
            const recordedWeight = transactions.reduce((sum, t) => sum + t.weight, 0);
            const totalBuyAmount = transactions.filter(t => t.type === 'buy').reduce((sum, t) => sum + t.amount, 0);
            const totalSellAmount = Math.abs(transactions.filter(t => t.type === 'sell').reduce((sum, t) => sum + t.amount, 0));
            const historicalSellFees = transactions.filter(t => t.type === 'sell').reduce((sum, t) => sum + t.fee, 0);
            const totalSellNetIncome = totalSellAmount - historicalSellFees; // å–å‡ºå‡€æ”¶å…¥
            const totalInvested = totalBuyAmount - totalSellNetIncome; // å‡€æŠ•å…¥èµ„é‡‘ = ä¹°å…¥é‡‘é¢ - å–å‡ºå‡€æ”¶å…¥
            const totalFeesAmount = transactions.reduce((sum, t) => sum + t.fee, 0);
            const buyTransactions = transactions.filter(t => t.type === 'buy').length;
            const sellTransactions = transactions.filter(t => t.type === 'sell').length;
            
            // è®¡ç®—æ€»ä½“ç»Ÿè®¡
            let totalRemainingCost = 0;
            let totalRemainingWeight = 0;
            
            // è®¡ç®—æ‰€æœ‰é“¶è¡Œçš„æ€»æˆæœ¬å’Œæ€»é‡é‡
            transactions.forEach(t => {
                totalRemainingWeight += t.weight;
                if (t.type === 'buy') {
                    totalRemainingCost += t.amount;
                } else if (t.type === 'sell') {
                    // å–å‡ºå‡å°‘æ€»æˆæœ¬ï¼ˆå‡å»å‡€æ”¶å…¥ï¼‰
                    const sellNetIncome = Math.abs(t.amount) - t.fee;
                    totalRemainingCost -= sellNetIncome;
                }
            });
            
            const avgPrice = totalRemainingWeight > 0 ? totalRemainingCost / totalRemainingWeight : 0;
            const actualTotalFunds = totalFunds || totalInvested;
            
            // æ€»æŒä»“å°±æ˜¯è®°å½•çš„å®é™…æŒä»“é‡é‡
            const actualTotalWeight = recordedWeight;
            
            // é‡æ–°è®¾è®¡ä»·å€¼è®¡ç®—ï¼šæ€»ä»·å€¼ã€å‡€ä»·å€¼ã€æ‰‹ç»­è´¹
            let grossValue = 0;  // æ€»ä»·å€¼ï¼ˆä¸è€ƒè™‘æ‰‹ç»­è´¹ï¼‰
            let totalSellFees = 0;  // å…¨éƒ¨å–å‡ºéœ€è¦çš„æ‰‹ç»­è´¹
            const bankWeights = {};
            
            // è®¡ç®—å„é“¶è¡Œçš„æŒä»“é‡é‡
            transactions.forEach(t => {
                if (!bankWeights[t.bank]) bankWeights[t.bank] = 0;
                bankWeights[t.bank] += t.weight;
            });
            
            // è®¡ç®—æ€»ä»·å€¼å’Œå–å‡ºæ‰‹ç»­è´¹
            Object.keys(bankWeights).forEach(bank => {
                if (bankWeights[bank] > 0) {
                    const bankPrice = getBankPrice(bank);
                    const bankGrossValue = bankWeights[bank] * bankPrice;
                    grossValue += bankGrossValue;
                    
                    // è®¡ç®—å¦‚æœç°åœ¨å…¨éƒ¨å–å‡ºè¿™ä¸ªé“¶è¡Œçš„é»„é‡‘éœ€è¦çš„æ‰‹ç»­è´¹
                    if (bank === 'æ°‘ç”Ÿé“¶è¡Œ') {
                        totalSellFees += bankWeights[bank] * 3; // 3å…ƒæ¯å…‹
                    } else if (bank.includes('(JD)')) {
                        totalSellFees += bankGrossValue * 0.004; // åƒåˆ†ä¹‹å››
                    }
                }
            });
            
            // å‡€ä»·å€¼ = æ€»ä»·å€¼ - å–å‡ºæ‰‹ç»­è´¹
            const netValue = grossValue - totalSellFees;
            const currentValue = netValue; // ä½¿ç”¨å‡€ä»·å€¼ä½œä¸ºå½“å‰ä»·å€¼
            
            // å‰©ä½™èµ„é‡‘ = æ€»èµ„é‡‘ - å‡€æŠ•å…¥èµ„é‡‘
            const remainingFunds = actualTotalFunds - totalInvested;
            
            // æ€»ç›ˆäº = å½“å‰ä»·å€¼ - å‡€æŠ•å…¥èµ„é‡‘
            const totalProfitLoss = currentValue - totalInvested;
            const profitRate = totalInvested > 0 ? (totalProfitLoss / totalInvested) * 100 : 0;
            
            // è®¡ç®—åŠ æƒå¹³å‡ä¿æœ¬å‡ä»·ï¼ˆä½¿ç”¨æ€»æˆæœ¬æ³•ï¼‰
            let breakEvenPrice = 0;
            let totalBreakEvenValue = 0;
            let totalWeight = 0;
            
            Object.keys(bankWeights).forEach(bank => {
                if (bankWeights[bank] > 0) {
                    // ä½¿ç”¨æ€»æˆæœ¬æ³•è®¡ç®—æˆæœ¬å‡ä»·
                    const bankCurrentAvgPrice = calculateCurrentBankAvgPrice(bank);
                    
                    let bankBreakEvenPrice = 0;
                    if (bank === 'æ°‘ç”Ÿé“¶è¡Œ') {
                        bankBreakEvenPrice = bankCurrentAvgPrice + 3; // 3å…ƒæ¯å…‹
                    } else if (bank.includes('(JD)')) {
                        bankBreakEvenPrice = bankCurrentAvgPrice / (1 - 0.004); // åƒåˆ†ä¹‹å››æ‰‹ç»­è´¹
                    } else {
                        bankBreakEvenPrice = bankCurrentAvgPrice;
                    }
                    
                    totalBreakEvenValue += bankBreakEvenPrice * bankWeights[bank];
                    totalWeight += bankWeights[bank];
                }
            });
            
            if (totalWeight > 0) {
                breakEvenPrice = totalBreakEvenValue / totalWeight;
            }
            
            // è®¡ç®—å·²å®ç°ç›ˆäºï¼ˆä½¿ç”¨æ–°çš„å‡€ç›ˆäºå­—æ®µï¼‰
            const realizedProfitLoss = transactions
                .filter(t => t.type === 'sell')
                .reduce((sum, t) => {
                    // å…¼å®¹æ—§æ•°æ®ï¼šå¦‚æœæ²¡æœ‰realizedProfitLosså­—æ®µï¼Œä½¿ç”¨æ—§è®¡ç®—æ–¹æ³•
                    if (t.realizedProfitLoss !== undefined) {
                        return sum + t.realizedProfitLoss;
                    } else {
                        // æ—§æ•°æ®å…¼å®¹ï¼šç®€å•çš„å–å‡ºé‡‘é¢å‡å»æ‰‹ç»­è´¹
                        return sum + Math.abs(t.amount) - t.fee;
                    }
                }, 0);
            
            // è®¡ç®—é£é™©ç­‰çº§
            const riskLevel = calculateRiskLevel(actualTotalWeight, actualTotalFunds);
            
            // è®¡ç®—ç›®æ ‡è¿›åº¦
            let targetProgress = 0;
            if (targetPrice > 0 && currentGoldPrice > 0) {
                targetProgress = ((currentGoldPrice - breakEvenPrice) / (targetPrice - breakEvenPrice)) * 100;
            }

            // æ›´æ–°æ ¸å¿ƒç›ˆäºé¢æ¿
            updateProfitOverview(totalProfitLoss, profitRate, totalInvested, grossValue, netValue, totalSellFees, actualTotalFunds, remainingFunds);
            
            // æ›´æ–°è¯¦ç»†ç»Ÿè®¡
            document.getElementById('totalPosition').innerHTML = `${parseFloat(actualTotalWeight.toFixed(4))}<span class="unit">å…‹</span>`;
            document.getElementById('avgPriceDisplay').textContent = parseFloat(avgPrice.toFixed(4));
            
            document.getElementById('breakEvenPrice').innerHTML = `${parseFloat(breakEvenPrice.toFixed(4))}<span class="unit">å…ƒ/å…‹</span>`;
            
            // è®¡ç®—åŠ æƒå¹³å‡å½“å‰ä»·æ ¼
            let weightedCurrentPrice = 0;
            if (totalWeight > 0) {
                Object.keys(bankWeights).forEach(bank => {
                    if (bankWeights[bank] > 0) {
                        const bankPrice = getBankPrice(bank);
                        weightedCurrentPrice += bankPrice * bankWeights[bank] / totalWeight;
                    }
                });
            }
            
            const breakEvenDiff = breakEvenPrice - weightedCurrentPrice;
            document.getElementById('breakEvenStatus').innerHTML = breakEvenDiff > 0 ? 
                `éœ€ä¸Šæ¶¨: ${parseFloat(breakEvenDiff.toFixed(4))}å…ƒ/å…‹` : 
                `å·²è¶…è¿‡: ${parseFloat(Math.abs(breakEvenDiff).toFixed(4))}å…ƒ/å…‹`;
            
            document.getElementById('totalTrades').innerHTML = `${buyTransactions + sellTransactions}<span class="unit">ç¬”</span>`;
            document.getElementById('buyTrades').textContent = buyTransactions;
            document.getElementById('sellTrades').textContent = sellTransactions;
            
            const realizedElement = document.getElementById('realizedProfitLoss');
            realizedElement.innerHTML = `${parseFloat(realizedProfitLoss.toFixed(4))}<span class="unit">å…ƒ</span>`;
            realizedElement.className = `value ${realizedProfitLoss >= 0 ? 'profit-positive' : 'profit-negative'}`;
            document.getElementById('totalFees').textContent = parseFloat(totalFeesAmount.toFixed(4));
            
            document.getElementById('targetProgress').innerHTML = targetPrice > 0 ? 
                `${parseFloat(targetProgress.toFixed(1))}<span class="unit">%</span>` : 
                `-<span class="unit">%</span>`;
            document.getElementById('targetPrice').textContent = targetPrice > 0 ? parseFloat(targetPrice.toFixed(4)) : '-';
            
            // document.getElementById('riskLevel').textContent = riskLevel.level;
            // document.getElementById('concentrationRisk').textContent = riskLevel.concentration;

            // æ›´æ–°é…ç½®æ˜¾ç¤º
            document.getElementById('displayTotalFunds').textContent = parseFloat(actualTotalFunds.toFixed(4));
            document.getElementById('displayRecordedFunds').textContent = parseFloat(totalInvested.toFixed(4));
            document.getElementById('displayUnrecordedFunds').textContent = parseFloat((actualTotalFunds - totalInvested).toFixed(4));

            // æ›´æ–°åˆ†é“¶è¡ŒæŒä»“è¯¦æƒ…
            updateBankSummary();
        }

        function updateProfitOverview(totalProfitLoss, profitRate, invested, grossValue, netValue, sellFees, totalFunds, remainingFunds) {
            const profitAmount = document.getElementById('totalProfitLoss');
            const profitRateElement = document.getElementById('totalProfitRate');
            const profitBadge = document.getElementById('profitBadge');
            const principalElement = document.getElementById('principalAmount');
            const grossValueElement = document.getElementById('grossTotalValue');
            const netValueElement = document.getElementById('netTotalValue');
            const sellFeesElement = document.getElementById('sellFeesAmount');
            
            // ä¸‡æ ¼å¼åŒ–å‡½æ•°
            function formatToWan(amount) {
                if (Math.abs(amount) >= 10000) {
                    return `${(amount / 10000).toFixed(2)}ä¸‡`;
                } else {
                    return `${amount.toFixed(2)}`;
                }
            }
            
            // æ›´æ–°é‡‘é¢
            profitAmount.querySelector('.amount').textContent = formatToWan(totalProfitLoss);
            profitRateElement.querySelector('.rate').textContent = `${profitRate.toFixed(2)}%`;
            
            // æ›´æ–°çŠ¶æ€æ ‡è¯†
            if (totalProfitLoss > 0) {
                profitBadge.textContent = 'ç›ˆåˆ©';
                profitBadge.className = 'profit-badge profit';
                profitAmount.style.color = '#ff3b30';
            } else if (totalProfitLoss < 0) {
                profitBadge.textContent = 'äºæŸ';
                profitBadge.className = 'profit-badge loss';
                profitAmount.style.color = '#34c759';
            } else {
                profitBadge.textContent = 'æŒå¹³';
                profitBadge.className = 'profit-badge neutral';
                profitAmount.style.color = 'white';
            }
            
            // æ›´æ–°è¯¦ç»†ä¿¡æ¯
            principalElement.textContent = `${formatToWan(invested)}å…ƒ`;
            grossValueElement.textContent = `${formatToWan(grossValue)}å…ƒ`;
            netValueElement.textContent = `${formatToWan(netValue)}å…ƒ`;
            sellFeesElement.textContent = `${formatToWan(sellFees)}å…ƒ`;
            
            // æ›´æ–°èµ„é‡‘è¿›åº¦
            updateFundsProgress(invested, totalFunds, remainingFunds);
        }

        function updateFundsProgress(invested, totalFunds, remainingFunds) {
            const progressText = document.getElementById('fundsProgressText');
            const progressFill = document.getElementById('fundsProgressFill');
            const remainingFundsElement = document.getElementById('remainingFundsAmount');
            const usageRateElement = document.getElementById('fundsUsageRate');
            
            // è®¡ç®—ä½¿ç”¨ç‡
            const usageRate = totalFunds > 0 ? (invested / totalFunds) * 100 : 0;
            
            // ä¸‡æ ¼å¼åŒ–å‡½æ•°
            function formatToWan(amount) {
                if (amount >= 10000) {
                    return `${(amount / 10000).toFixed(2)}ä¸‡`;
                } else {
                    return `${amount.toFixed(2)}`;
                }
            }
            
            // æ›´æ–°è¿›åº¦æ–‡æœ¬
            progressText.textContent = `${formatToWan(invested)} / ${formatToWan(totalFunds)}`;
            
            // æ›´æ–°è¿›åº¦æ¡
            progressFill.style.width = `${Math.min(usageRate, 100)}%`;
            
            // æ ¹æ®ä½¿ç”¨ç‡è°ƒæ•´è¿›åº¦æ¡é¢œè‰²
            if (usageRate >= 90) {
                progressFill.style.background = 'linear-gradient(90deg, #ff9500, #ff6347)';
            } else if (usageRate >= 70) {
                progressFill.style.background = 'linear-gradient(90deg, #ffcc02, #ff9500)';
            } else {
                progressFill.style.background = 'linear-gradient(90deg, #34c759, #30d158)';
            }
            
            // æ›´æ–°è¯¦ç»†ä¿¡æ¯
            remainingFundsElement.textContent = `${formatToWan(remainingFunds)}å…ƒ`;
            usageRateElement.textContent = `${usageRate.toFixed(1)}%`;
        }

        function calculateRiskLevel(totalWeight, totalFunds) {
            if (totalFunds === 0) return { level: 'æ— é£é™©', concentration: 'æ— æŒä»“' };
            
            // è®¡ç®—é›†ä¸­åº¦é£é™©ï¼ˆåŸºäºé“¶è¡Œæ•°é‡ï¼‰
            const bankCount = [...new Set(transactions.map(t => t.bank))].length;
            let concentrationRisk = '';
            if (bankCount === 1) concentrationRisk = 'é«˜é›†ä¸­';
            else if (bankCount === 2) concentrationRisk = 'ä¸­ç­‰é›†ä¸­';
            else concentrationRisk = 'åˆ†æ•£';
            
            // è®¡ç®—æ€»ä½“é£é™©ç­‰çº§
            let riskLevel = 'ä½é£é™©';
            if (totalFunds > 100000) riskLevel = 'ä¸­é£é™©';
            if (totalFunds > 500000) riskLevel = 'é«˜é£é™©';
            
            return { level: riskLevel, concentration: concentrationRisk };
        }

        function updateBankSummary() {
            const bankData = {};
            const banks = ['æ°‘ç”Ÿé“¶è¡Œ', 'æ°‘ç”Ÿé“¶è¡Œ(JD)', 'æµ™å•†é“¶è¡Œ(JD)'];
            
            // åˆå§‹åŒ–é“¶è¡Œæ•°æ®
            banks.forEach(bank => {
                bankData[bank] = {
                    weight: 0,
                    totalCost: 0,       // æ€»æˆæœ¬ï¼ˆä¹°å…¥æˆæœ¬-å–å‡ºå‡€æ”¶å…¥ï¼‰
                    avgPrice: 0,        // æˆæœ¬å‡ä»·
                    breakEvenPrice: 0,
                    grossValue: 0,      // æ€»ä»·å€¼
                    sellFee: 0,         // æ‰‹ç»­è´¹
                    netValue: 0,        // å‡€ä»·å€¼
                    profitLoss: 0,      // æœªå®ç°ç›ˆäº
                    historicalProfitLoss: 0  // å†å²ç›ˆäº
                };
            });

            // è®¡ç®—å„é“¶è¡Œæ•°æ®
            transactions.forEach(t => {
                if (bankData[t.bank]) {
                    bankData[t.bank].weight += t.weight;
                    if (t.type === 'buy') {
                        // ä¹°å…¥å¢åŠ æ€»æˆæœ¬
                        bankData[t.bank].totalCost += t.amount;
                    } else if (t.type === 'sell') {
                        // å–å‡ºå‡å°‘æ€»æˆæœ¬ï¼ˆå‡å»å‡€æ”¶å…¥ï¼šå–å‡ºé‡‘é¢-æ‰‹ç»­è´¹ï¼‰
                        const sellNetIncome = Math.abs(t.amount) - t.fee;
                        bankData[t.bank].totalCost -= sellNetIncome;
                        
                        // ç´¯è®¡å†å²ç›ˆäº
                        if (t.realizedProfitLoss !== undefined) {
                            bankData[t.bank].historicalProfitLoss += t.realizedProfitLoss;
                        } else {
                            // å…¼å®¹æ—§æ•°æ®ï¼šç®€å•è®¡ç®—
                            bankData[t.bank].historicalProfitLoss += sellNetIncome;
                        }
                    }
                }
            });

            // è®¡ç®—å‡ä»·å’Œä¿æœ¬å‡ä»·
            Object.keys(bankData).forEach(bank => {
                const data = bankData[bank];
                if (data.weight > 0) {
                    // å‡ä»· = æ€»æˆæœ¬ / å½“å‰æŒä»“å…‹æ•°
                    data.avgPrice = data.totalCost / data.weight;
                    
                    // ä¸åŒé“¶è¡Œçš„ä¿æœ¬å‡ä»·
                    if (bank === 'æ°‘ç”Ÿé“¶è¡Œ') {
                        data.breakEvenPrice = data.avgPrice + 3; // 3å…ƒæ¯å…‹
                    } else if (bank.includes('(JD)')) {
                        data.breakEvenPrice = data.avgPrice / (1 - 0.004); // åƒåˆ†ä¹‹å››æ‰‹ç»­è´¹
                    }
                    
                    // ä½¿ç”¨å¯¹åº”é“¶è¡Œçš„ä»·æ ¼è®¡ç®—æ€»ä»·å€¼
                    const bankPrice = getBankPrice(bank);
                    data.grossValue = data.weight * bankPrice;
                    
                    // è®¡ç®—è¯¥é“¶è¡Œçš„å–å‡ºæ‰‹ç»­è´¹
                    if (bank === 'æ°‘ç”Ÿé“¶è¡Œ') {
                        data.sellFee = data.weight * 3; // 3å…ƒæ¯å…‹
                    } else if (bank.includes('(JD)')) {
                        data.sellFee = data.grossValue * 0.004; // åƒåˆ†ä¹‹å››
                    } else {
                        data.sellFee = 0;
                    }
                    
                    // å‡€ä»·å€¼ = æ€»ä»·å€¼ - æ‰‹ç»­è´¹
                    data.netValue = data.grossValue - data.sellFee;
                    
                    // ç›ˆäº = å‡€ä»·å€¼ - æ€»æˆæœ¬
                    data.profitLoss = data.netValue - data.totalCost;
                }
            });

            // æ¸²æŸ“è¡¨æ ¼
            const tbody = document.getElementById('bankSummaryTable');
            tbody.innerHTML = '';

            // æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•äº¤æ˜“æ•°æ®ï¼ˆåŒ…æ‹¬å†å²ï¼‰
            const hasAnyData = Object.values(bankData).some(data => data.weight !== 0 || data.historicalProfitLoss !== 0);
            
            if (hasAnyData) {
                Object.keys(bankData).forEach(bank => {
                    const data = bankData[bank];
                    // åªæ˜¾ç¤ºæœ‰æŒä»“æˆ–æœ‰å†å²ç›ˆäºçš„é“¶è¡Œ
                    if (data.weight !== 0 || data.historicalProfitLoss !== 0) {
                        const row = tbody.insertRow();
                        
                        if (data.weight > 0) {
                            // æœ‰æŒä»“çš„é“¶è¡Œï¼šæ˜¾ç¤ºå®Œæ•´ä¿¡æ¯
                            const profitClass = data.profitLoss >= 0 ? 'profit-positive' : 'profit-negative';
                            const bankPrice = getBankPrice(bank);
                            const lastUpdate = bankPrices[bank]?.lastUpdate || '';
                            const priceStyle = lastUpdate ? 'color: #34c759; font-weight: 600;' : 'color: #86868b;';
                            const historicalProfitClass = data.historicalProfitLoss >= 0 ? 'profit-positive' : 'profit-negative';
                            
                            row.innerHTML = `
                                <td>${bank}</td>
                                <td>${parseFloat(data.weight.toFixed(4))}</td>
                                <td style="font-weight: 600; color: #007aff;">${parseFloat(data.totalCost.toFixed(4))}</td>
                                <td>${parseFloat(data.avgPrice.toFixed(4))}</td>
                                <td style="${priceStyle}">
                                    ${parseFloat(bankPrice.toFixed(4))}
                                    ${lastUpdate ? `<br><small style="font-size: 11px; color: #86868b;">${lastUpdate.slice(-8)}</small>` : '<br><small style="font-size: 11px; color: #86868b;">æœªæ›´æ–°</small>'}
                                </td>
                                <td>${parseFloat(data.breakEvenPrice.toFixed(4))}</td>
                                <td>${parseFloat(data.grossValue.toFixed(4))}</td>
                                <td style="color: #ff3b30;">${parseFloat(data.sellFee.toFixed(4))}</td>
                                <td style="font-weight: 600;">${parseFloat(data.netValue.toFixed(4))}</td>
                                <td class="${profitClass}">${parseFloat(data.profitLoss.toFixed(4))}</td>
                                <td class="${historicalProfitClass}" style="font-weight: 600;">${parseFloat(data.historicalProfitLoss.toFixed(4))}</td>
                            `;
                        } else {
                            // æ— æŒä»“ä½†æœ‰å†å²ç›ˆäºçš„é“¶è¡Œï¼šåªæ˜¾ç¤ºå†å²ç›ˆäºï¼Œå…¶ä»–å…¨éƒ¨ä¸º0
                            const historicalProfitClass = data.historicalProfitLoss >= 0 ? 'profit-positive' : 'profit-negative';
                            
                            row.innerHTML = `
                                <td>${bank}</td>
                                <td style="color: #86868b;">0</td>
                                <td style="color: #86868b;">0</td>
                                <td style="color: #86868b;">-</td>
                                <td style="color: #86868b;">-</td>
                                <td style="color: #86868b;">-</td>
                                <td style="color: #86868b;">0</td>
                                <td style="color: #86868b;">0</td>
                                <td style="color: #86868b;">0</td>
                                <td style="color: #86868b;">0</td>
                                <td class="${historicalProfitClass}" style="font-weight: 600;">${parseFloat(data.historicalProfitLoss.toFixed(4))}</td>
                            `;
                        }
                    }
                });
            } else {
                // æ˜¾ç¤ºç©ºçŠ¶æ€æç¤º
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td colspan="11" style="text-align: center; color: #86868b; padding: 30px; font-style: italic;">
                        æš‚æ— äº¤æ˜“è®°å½•ï¼Œè¯·å…ˆæ·»åŠ äº¤æ˜“
                    </td>
                `;
            }
        }

        function updateTotalFunds() {
            totalFunds = parseFloat(document.getElementById('modalTotalFunds').value) || 0;
            localStorage.setItem('totalFunds', totalFunds);
            updateSummary();
        }

        function updateCurrentPrice() {
            currentGoldPrice = parseFloat(document.getElementById('modalCurrentGoldPrice').value) || 520;
            localStorage.setItem('currentGoldPrice', currentGoldPrice);
            updateSummary();
        }

        function updateTargetPrice() {
            targetPrice = parseFloat(document.getElementById('modalTargetPrice').value) || 0;
            localStorage.setItem('targetPrice', targetPrice);
            updateSummary();
        }

        function openConfigModal() {
            document.getElementById('modalCurrentGoldPrice').value = currentGoldPrice;
            document.getElementById('modalTotalFunds').value = totalFunds;
            document.getElementById('modalTargetPrice').value = targetPrice;
            document.getElementById('modalUpdateInterval').value = updateInterval;
            document.getElementById('configModal').style.display = 'block';
            
            // æ›´æ–°é…ç½®æ˜¾ç¤º
            updateConfigDisplay();
            updatePriceStatus(autoUpdateEnabled ? 'running' : 'stopped', 
                autoUpdateEnabled ? `è‡ªåŠ¨æ›´æ–°è¿è¡Œä¸­ (${updateInterval}ç§’é—´éš”)` : 'æ‰‹åŠ¨æ¨¡å¼');
        }

        function closeConfigModal() {
            document.getElementById('configModal').style.display = 'none';
        }

        function openAddRecordModal() {
            document.getElementById('tradeType').value = 'buy'; // é»˜è®¤ä¹°å…¥
            document.getElementById('bank').value = 'æ°‘ç”Ÿé“¶è¡Œ'; // é»˜è®¤æ°‘ç”Ÿé“¶è¡Œ
            document.getElementById('inputMode').value = 'byWeight';
            onInputModeChange();
            document.getElementById('weight').value = '';
            document.getElementById('amount').value = '';
            document.getElementById('price').value = '';
            document.getElementById('tradeDate').value = new Date().toISOString().split('T')[0];
            updateBankAvgPriceInfo(); // æ›´æ–°é“¶è¡Œå‡ä»·ä¿¡æ¯
            document.getElementById('addRecordModal').style.display = 'block';
        }

        // æ›´æ–°é“¶è¡Œå‡ä»·ä¿¡æ¯æ˜¾ç¤º
        function updateBankAvgPriceInfo() {
            const tradeType = document.getElementById('tradeType').value;
            const bank = document.getElementById('bank').value;
            const infoDiv = document.getElementById('bankAvgPriceInfo');
            
            if (tradeType === 'sell') {
                const avgPrice = calculateBankAvgPrice(bank);
                const currentAvgPrice = calculateCurrentBankAvgPrice(bank);
                const bankWeight = transactions.filter(t => t.bank === bank).reduce((sum, t) => sum + t.weight, 0);
                
                if (avgPrice > 0 && bankWeight > 0) {
                    infoDiv.style.display = 'block';
                    infoDiv.innerHTML = `
                        <div style="margin-bottom: 8px;">
                            <strong>${bank}</strong> æŒä»“ä¿¡æ¯ï¼š
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 11px;">
                            <div>å½“å‰æŒä»“: <span style="color: #007aff; font-weight: 600;">${parseFloat(bankWeight.toFixed(4))}å…‹</span></div>
                            <div>ä¹°å…¥å‡ä»·: <span style="color: #007aff; font-weight: 600;">${parseFloat(avgPrice.toFixed(4))}å…ƒ/å…‹</span></div>
                            <div>æˆæœ¬å‡ä»·: <span style="color: #007aff; font-weight: 600;">${parseFloat(currentAvgPrice.toFixed(4))}å…ƒ/å…‹</span></div>
                            <div style="color: #666;">è®¡ç®—åŸºç¡€: æ€»æˆæœ¬æ³•</div>
                        </div>
                        <div style="margin-top: 8px; font-size: 11px; color: #666;">
                            å‡€ç›ˆäº = (å–å‡ºä»·æ ¼ - ä¹°å…¥å‡ä»·) Ã— é‡é‡ - æ‰‹ç»­è´¹<br>
                            <small style="color: #999;">æˆæœ¬å‡ä»· = æ€»æˆæœ¬ Ã· æ€»æŒä»“</small>
                        </div>
                    `;
                } else {
                    infoDiv.style.display = 'block';
                    infoDiv.innerHTML = `
                        <span style="color: #ff6b6b;">æ³¨æ„: ${bank} æš‚æ— æŒä»“æˆ–ä¹°å…¥è®°å½•</span>
                    `;
                }
            } else {
                infoDiv.style.display = 'none';
            }
        }

        // è®¡ç®—é¢„æœŸç›ˆäº
        function calculateExpectedProfit() {
            const tradeType = document.getElementById('tradeType').value;
            const bank = document.getElementById('bank').value;
            const inputWeight = parseFloat(document.getElementById('weight').value);
            const inputPrice = parseFloat(document.getElementById('price').value);
            const expectedProfitDiv = document.getElementById('expectedProfitInfo');
            
            if (tradeType === 'sell' && inputWeight > 0 && inputPrice > 0) {
                // ä½¿ç”¨æ ‡å‡†åŒ–ç²¾åº¦
                const weight = parseFloat(inputWeight.toFixed(4));
                const price = parseFloat(inputPrice.toFixed(4));
                
                const avgPrice = calculateBankAvgPrice(bank);
                const currentWeight = parseFloat(transactions.filter(t => t.bank === bank).reduce((sum, t) => sum + t.weight, 0).toFixed(4));
                
                if (avgPrice > 0 && currentWeight >= weight) {
                    const amount = parseFloat((weight * price).toFixed(2));
                    const fee = parseFloat(calculateFee('sell', bank, weight, amount).toFixed(4));
                    const expectedProfit = parseFloat(((price - avgPrice) * weight - fee).toFixed(4));
                    const profitRate = parseFloat(((price - avgPrice) / avgPrice * 100).toFixed(2));
                    
                    const profitClass = expectedProfit >= 0 ? '#34c759' : '#ff3b30';
                    const profitText = expectedProfit >= 0 ? 'é¢„æœŸç›ˆåˆ©' : 'é¢„æœŸäºæŸ';
                    
                    expectedProfitDiv.style.display = 'block';
                    expectedProfitDiv.innerHTML = `
                        <div style="font-weight: 600; margin-bottom: 6px; color: ${profitClass};">
                            ğŸ“Š ${profitText}: ${parseFloat(Math.abs(expectedProfit).toFixed(4))}å…ƒ
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px; font-size: 11px;">
                            <div>å–å‡ºé‡‘é¢: ${parseFloat(amount.toFixed(4))}å…ƒ</div>
                            <div>æ‰‹ç»­è´¹: ${parseFloat(fee.toFixed(4))}å…ƒ</div>
                            <div>ä»·å·®: ${parseFloat((price - avgPrice).toFixed(4))}å…ƒ/å…‹</div>
                            <div style="color: ${profitClass};">æ”¶ç›Šç‡: ${parseFloat(profitRate.toFixed(2))}%</div>
                        </div>
                        <div style="margin-top: 6px; font-size: 10px; color: #666;">
                            è®¡ç®—å…¬å¼: (${price} - ${parseFloat(avgPrice.toFixed(4))}) Ã— ${weight} - ${parseFloat(fee.toFixed(4))} = ${parseFloat(expectedProfit.toFixed(4))}
                        </div>
                    `;
                } else if (currentWeight < weight) {
                    expectedProfitDiv.style.display = 'block';
                    expectedProfitDiv.style.borderLeftColor = '#ff3b30';
                    expectedProfitDiv.innerHTML = `
                        <span style="color: #ff3b30;">âš ï¸ å–å‡ºæ•°é‡è¶…è¿‡æŒä»“ (å½“å‰æŒä»“: ${currentWeight}å…‹)</span>
                    `;
                } else {
                    expectedProfitDiv.style.display = 'block';
                    expectedProfitDiv.style.borderLeftColor = '#ff3b30';
                    expectedProfitDiv.innerHTML = `
                        <span style="color: #ff3b30;">âš ï¸ è¯¥é“¶è¡Œæš‚æ— æŒä»“è®°å½•</span>
                    `;
                }
            } else {
                expectedProfitDiv.style.display = 'none';
            }
        }

        function closeAddRecordModal() {
            document.getElementById('addRecordModal').style.display = 'none';
        }

        // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­å¼¹çª—
        window.onclick = function(event) {
            const configModal = document.getElementById('configModal');
            const addRecordModal = document.getElementById('addRecordModal');
            if (event.target === configModal) {
                closeConfigModal();
            }
            if (event.target === addRecordModal) {
                closeAddRecordModal();
            }
        }

        function clearForm() {
            document.getElementById('weight').value = '';
            document.getElementById('price').value = '';
        }

        function saveData() {
            localStorage.setItem('goldTransactions', JSON.stringify(transactions));
        }

        // å¯¼å‡ºæ•°æ®ä¸ºJSONæ–‡ä»¶
        function exportData() {
            const data = {
                transactions,
                currentGoldPrice,
                totalFunds,
                targetPrice,
                bankPrices,
                autoUpdateEnabled,
                updateInterval
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'gold_data.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // å¯¼å…¥JSONæ•°æ®
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.transactions) {
                        transactions = data.transactions;
                        localStorage.setItem('goldTransactions', JSON.stringify(transactions));
                    }
                    if (data.currentGoldPrice) {
                        currentGoldPrice = data.currentGoldPrice;
                        localStorage.setItem('currentGoldPrice', currentGoldPrice);
                    }
                    if (data.totalFunds) {
                        totalFunds = data.totalFunds;
                        localStorage.setItem('totalFunds', totalFunds);
                    }
                    if (data.targetPrice) {
                        targetPrice = data.targetPrice;
                        localStorage.setItem('targetPrice', targetPrice);
                    }
                    if (data.bankPrices) {
                        bankPrices = data.bankPrices;
                        localStorage.setItem('bankPrices', JSON.stringify(bankPrices));
                    }
                    if (typeof data.autoUpdateEnabled !== 'undefined') {
                        autoUpdateEnabled = data.autoUpdateEnabled;
                        localStorage.setItem('autoUpdateEnabled', autoUpdateEnabled);
                    }
                    if (data.updateInterval) {
                        updateInterval = data.updateInterval;
                        localStorage.setItem('updateInterval', updateInterval);
                    }
                    renderTransactions();
                    updateSummary();
                    updateConfigDisplay();
                    alert('æ•°æ®å¯¼å…¥æˆåŠŸï¼');
                } catch (err) {
                    alert('å¯¼å…¥å¤±è´¥ï¼Œæ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®ï¼');
                }
            };
            reader.readAsText(file);
        }
    </script>
</body>
</html>
